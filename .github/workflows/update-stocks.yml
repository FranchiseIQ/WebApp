name: Update Stock Data for FranchiseMap Ticker

on:
  schedule:
    # Every 30 minutes during market hours (Mon-Fri, 9:30 AM - 4:30 PM ET)
    # GitHub Actions uses UTC, so 9:30 AM ET = 14:30 UTC (13:30 during DST)
    - cron: '*/30 14-21 * * 1-5'
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  update-stocks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install yfinance pandas requests

      - name: Create stock data script
        run: |
          mkdir -p FranchiseMap/data
          python3 << 'EOF'
          import json
          import yfinance as yf
          from datetime import datetime

          tickers = ['CMG', 'SBUX', 'MCD', 'WEN', 'WING', 'SHAK', 'DPZ']
          stock_data = []

          for ticker in tickers:
              try:
                  stock = yf.Ticker(ticker)
                  hist = stock.history(period='1d')
                  if not hist.empty:
                      latest = hist.iloc[-1]
                      stock_data.append({
                          'ticker': ticker,
                          'price': round(float(latest['Close']), 2),
                          'change': round(float(latest['Close'] - latest['Open']), 2),
                          'changePercent': round(float((latest['Close'] - latest['Open']) / latest['Open'] * 100), 2),
                          'timestamp': datetime.now().isoformat()
                      })
              except Exception as e:
                  print(f"Warning: Could not fetch {ticker}: {e}")

          with open('FranchiseMap/data/stocks.json', 'w') as f:
              json.dump(stock_data, f, indent=2)

          print(f"✅ Updated {len(stock_data)} stock prices")
          EOF

      - name: Validate stock data
        run: |
          if [ ! -f "FranchiseMap/data/stocks.json" ]; then
            echo "❌ Stock data file not created"
            exit 1
          fi

          if [ ! -s "FranchiseMap/data/stocks.json" ]; then
            echo "❌ Stock data file is empty"
            exit 1
          fi

          echo "✅ Stock data validated"
          cat FranchiseMap/data/stocks.json | head -5

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add FranchiseMap/data/stocks.json

          if git diff --staged --quiet; then
            echo "ℹ️  No stock data changes to commit."
            exit 0
          fi

          # Commit the stock data
          git commit -m "chore: update stock ticker data for FranchiseMap [skip ci]"

          # Ensure main branch exists and is up to date
          if ! git rev-parse --verify origin/main > /dev/null 2>&1; then
            echo "⚠️  Warning: main branch not found on remote, attempting to create..."
            git branch -M main || true
          fi

          # Pull latest changes from main to avoid conflicts
          if git fetch origin main; then
            git rebase origin/main || git merge --ff-only origin/main || {
              echo "⚠️  Merge conflict detected, using local version (latest stock data)"
              git merge -X ours origin/main || true
            }
          fi

          # Push to main with error handling
          if git push origin HEAD:main; then
            echo "✅ Stock data updated and pushed to main branch"
          else
            echo "❌ Error pushing to main, but stock data is valid"
            echo "This may be a network issue - the data will be pushed in the next run"
            exit 1
          fi
