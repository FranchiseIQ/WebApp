name: Generate Map Data

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  validate-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify data exists
        run: |
          if [ ! -d "FranchiseMap/data/brands" ]; then
            echo "❌ Data directory missing"
            exit 1
          fi

          manifest_count=$(cat FranchiseMap/data/manifest.json | grep -c '"ticker"')
          echo "✅ Found manifest with $manifest_count brands"

          total_files=$(ls FranchiseMap/data/brands/*.json 2>/dev/null | wc -l)
          echo "✅ Found $total_files brand data files"

      - name: Validate manifest format
        run: |
          python3 << 'EOF'
          import json
          with open('FranchiseMap/data/manifest.json', 'r') as f:
              data = json.load(f)

          if not isinstance(data, list):
              print("❌ Manifest is not a list")
              exit(1)

          for item in data:
              required = ['ticker', 'file', 'count', 'brands', 'name']
              missing = [k for k in required if k not in item]
              if missing:
                  print(f"❌ Item {item.get('ticker', '?')} missing: {missing}")
                  exit(1)

          print(f"✅ Manifest validated: {len(data)} brands")
          EOF

      - name: Upload data artifacts
        uses: actions/upload-artifact@v4
        with:
          name: franchise-data-snapshot
          path: FranchiseMap/data/
          retention-days: 7

      - name: Summary
        run: |
          echo "✅ Map data validation complete"
          echo "Data is ready for deployment to GitHub Pages"
