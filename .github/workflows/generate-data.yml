name: Generate FranchiseMap Locations & Metadata

on:
  # Run daily at 3 AM UTC (after batch processing) to generate/update all metadata
  schedule:
    - cron: '0 3 * * *'  # Every day at 3:00 AM UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create Data Directory
        run: mkdir -p FranchiseMap/data/brands

      - name: Run Data Generator
        run: |
          pip install requests
          echo "üîÑ Generating all franchise locations..."
          python -m data_aggregation.pipelines.franchise.generate_locations \
            --include-addresses \
            --include-hours \
            --include-contact \
            --enrich-details
          echo "‚úÖ Location generation complete"

      - name: Generate Brand Metadata
        run: |
          echo "üìù Building brand metadata..."
          python -m data_aggregation.pipelines.franchise.build_brand_metadata
          echo "‚úÖ Metadata generation complete"

      - name: Enrich All Location Data with Addresses
        run: |
          echo "üìç Enriching all location data with complete address information..."
          python3 << 'EOF'
          import json
          from pathlib import Path
          from time import sleep
          import requests

          # Process all location files and add address data
          data_dir = Path('FranchiseMap/data/brands')
          if not data_dir.exists():
            print("‚ÑπÔ∏è No location data found")
            exit(0)

          enriched_count = 0
          total_processed = 0
          failed_count = 0

          for brand_file in data_dir.glob('*.json'):
              try:
                  with open(brand_file, 'r', encoding='utf-8') as f:
                      brand_data = json.load(f)

                  # Process each location
                  if isinstance(brand_data, list):
                      for location in brand_data:
                          total_processed += 1
                          if 'lat' in location and 'lng' in location:
                              # Try to get address via reverse geocoding (Nominatim)
                              if 'address' not in location or not location.get('address'):
                                  try:
                                      url = f"https://nominatim.openstreetmap.org/reverse?format=json&lat={location['lat']}&lon={location['lng']}"
                                      response = requests.get(url, timeout=10, headers={'User-Agent': 'FranchiseMap'})
                                      response.raise_for_status()
                                      data = response.json()

                                      # Extract address components
                                      address_parts = []
                                      if 'address' in data:
                                          addr = data['address']
                                          city = addr.get('city', addr.get('town', ''))
                                          state = addr.get('state', '')
                                          postcode = addr.get('postcode', '')
                                          country = addr.get('country', '')

                                          if city:
                                              address_parts.append(city)
                                          if state:
                                              address_parts.append(state)
                                          if postcode:
                                              address_parts.append(postcode)

                                          location['address'] = ', '.join(address_parts)
                                          location['display_name'] = data.get('display_name', '')
                                          location['country'] = country

                                      enriched_count += 1
                                      sleep(0.15)  # Rate limiting per Nominatim ToS
                                  except Exception as e:
                                      failed_count += 1
                                      print(f"‚ö†Ô∏è Could not geocode {location.get('name', 'Unknown')}: {e}")

                  # Save enriched data
                  with open(brand_file, 'w', encoding='utf-8') as f:
                      json.dump(brand_data, f, indent=2, ensure_ascii=False)

              except Exception as e:
                  print(f"‚ö†Ô∏è Error processing {brand_file.name}: {e}")

          print(f"\n‚úÖ Enrichment Summary:")
          print(f"   Total Locations Processed: {total_processed}")
          print(f"   Addresses Added: {enriched_count}")
          print(f"   Failed Geocoding: {failed_count}")
          print(f"   Success Rate: {enriched_count*100//max(total_processed, 1)}%")
          EOF

      - name: Validate Location Data Completeness
        run: |
          echo "üîç Validating complete dataset..."
          python3 << 'EOF'
          import json
          from pathlib import Path

          data_dir = Path('FranchiseMap/data/brands')
          manifest_file = Path('FranchiseMap/data/manifest.json')

          stats = {
              'total_brands': 0,
              'total_locations': 0,
              'locations_with_address': 0,
              'locations_with_coords': 0,
              'locations_with_name': 0,
              'brands_complete': 0
          }

          if data_dir.exists():
              for brand_file in data_dir.glob('*.json'):
                  try:
                      with open(brand_file, 'r', encoding='utf-8') as f:
                          brand_data = json.load(f)

                      if isinstance(brand_data, list) and len(brand_data) > 0:
                          brand_complete = True
                          stats['total_brands'] += 1

                          for location in brand_data:
                              stats['total_locations'] += 1
                              if location.get('address'):
                                  stats['locations_with_address'] += 1
                              else:
                                  brand_complete = False
                              if 'lat' in location and 'lng' in location:
                                  stats['locations_with_coords'] += 1
                              if location.get('name'):
                                  stats['locations_with_name'] += 1

                          if brand_complete:
                              stats['brands_complete'] += 1

                  except Exception as e:
                      print(f"‚ö†Ô∏è Error validating {brand_file.name}: {e}")

          # Load manifest for comparison
          manifest_brands = 0
          if manifest_file.exists():
              with open(manifest_file, 'r') as f:
                  manifest = json.load(f)
                  manifest_brands = len(manifest)

          print("\nüìä LOCATION DATA COMPLETENESS REPORT")
          print("=" * 50)
          print(f"Total Brands: {stats['total_brands']} / {manifest_brands}")
          print(f"Total Locations: {stats['total_locations']:,}")
          print(f"\nData Completeness:")
          print(f"  ‚úÖ With Addresses: {stats['locations_with_address']:,} ({stats['locations_with_address']*100//max(stats['total_locations'], 1)}%)")
          print(f"  ‚úÖ With Coordinates: {stats['locations_with_coords']:,} ({stats['locations_with_coords']*100//max(stats['total_locations'], 1)}%)")
          print(f"  ‚úÖ With Names: {stats['locations_with_name']:,} ({stats['locations_with_name']*100//max(stats['total_locations'], 1)}%)")
          print(f"\nBrand Completeness:")
          print(f"  ‚úÖ Fully Complete: {stats['brands_complete']} / {stats['total_brands']}")
          print(f"\nüí° Next run: Daily at 3 AM UTC")
          EOF

      # --- SAFETY NET: Save data as a Zip file ---
      # If the push fails below, you can download this from the Actions Summary page!
      - name: Upload Data Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: franchise-data
          path: FranchiseMap/data/
          retention-days: 7

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add FranchiseMap/data/

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit."
            exit 0
          fi

          # Commit the data
          git commit -m "chore: Generate FranchiseMap locations and metadata [skip ci]"

          # Safely push to the current branch
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "üì§ Pushing to branch: $CURRENT_BRANCH"

          if git fetch origin "$CURRENT_BRANCH" 2>/dev/null; then
            git merge -X ours "origin/$CURRENT_BRANCH" || {
              echo "‚ö†Ô∏è  Merge conflict detected, using local version (latest data)"
              git merge -X ours "origin/$CURRENT_BRANCH" || true
            }
          fi

          if git push origin "$CURRENT_BRANCH"; then
            echo "‚úÖ Franchise data pushed successfully"
          else
            echo "‚ùå Error pushing changes, but data is valid"
            exit 1
          fi

