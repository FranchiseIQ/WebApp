name: 24/7 FranchiseMap Batch Processing Scheduler

on:
  schedule:
    # Run every 4 hours around the clock
    # This gives API time to cool between batches
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      manual_batch_size:
        description: 'Optional: Override batch size (default random 50-100)'
        required: false

permissions:
  contents: write

jobs:
  adaptive-batch-process:
    runs-on: ubuntu-latest
    name: Process Next Adaptive Batch

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create Data Directory
        run: mkdir -p FranchiseMap/data/brands

      - name: Install Dependencies
        run: |
          pip install requests

      - name: Run Adaptive Batch Processor
        id: batch_process
        continue-on-error: true
        run: |
          echo "üöÄ Starting adaptive batch processor..."
          python -m data_aggregation.pipelines.franchise.adaptive_batch_processor
          BATCH_EXIT_CODE=$?
          echo "batch_exit_code=$BATCH_EXIT_CODE" >> $GITHUB_OUTPUT
          exit $BATCH_EXIT_CODE

      - name: Check Batch Status
        if: always()
        run: |
          echo "üìä Checking current queue status..."
          python -m data_aggregation.pipelines.franchise.batch_processor --action status

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: batch-processing-logs-${{ github.run_id }}
          path: data_aggregation/logs/
          retention-days: 14

      - name: Upload Data Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: franchise-data-${{ github.run_id }}
          path: FranchiseMap/data/
          retention-days: 7

      - name: Commit and Push Changes
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add FranchiseMap/data/
          git add data_aggregation/processed_brands.txt
          git add data_aggregation/logs/ || true

          if ! git diff --staged --quiet; then
            git commit -m "chore: Auto-batch process FranchiseMap locations [skip ci]"
            git fetch origin && git merge -X ours origin/$(git rev-parse --abbrev-ref HEAD) || true
            git push
          else
            echo "No changes to commit"
          fi

      - name: Send Notification on Failure
        if: failure() && steps.batch_process.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è  Batch processing failed - check logs in artifacts"
          echo "The workflow will retry automatically in 4 hours"

      - name: Schedule Next Run
        if: success()
        run: |
          NEXT_RUN=$(date -d '+4 hours' '+%Y-%m-%d %H:%M:%S UTC')
          echo "‚úÖ Batch complete. Next automatic batch scheduled for: $NEXT_RUN"

  # Fallback: Email notifications on consistent failures (optional)
  notify-on-critical-failure:
    runs-on: ubuntu-latest
    needs: adaptive-batch-process
    if: failure()
    steps:
      - name: Check for Critical Failures
        run: |
          echo "‚ö†Ô∏è  Warning: Batch processing job failed"
          echo "The system will automatically retry in the next scheduled run"
          echo "Check the workflow logs for details"
