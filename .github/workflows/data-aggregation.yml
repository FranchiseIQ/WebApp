name: Data Aggregation Pipeline

on:
  schedule:
    # Run data aggregation daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  aggregate-data:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run Data Aggregation Pipeline
        working-directory: FranchiseMap/scripts
        env:
          CENSUS_API_KEY: ${{ secrets.CENSUS_API_KEY }}
          GOV_DATA_KEY: ${{ secrets.GOV_DATA_KEY }}
          BLS_KEY: ${{ secrets.BLS_KEY }}
        run: python3 run_data_aggregation.py
        timeout-minutes: 90

      - name: Generate data quality summary
        if: always()
        run: |
          echo "## Data Aggregation Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "FranchiseMap/data/data_quality_report.json" ]; then
            echo "âœ“ Data quality report generated" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF'
          import json
          with open('FranchiseMap/data/data_quality_report.json', 'r') as f:
              report = json.load(f)
              summary = report.get('summary', {})
              print(f"\n### Quality Metrics")
              print(f"- Total Locations: {summary.get('totalLocations', 0):,}")
              print(f"- With Demographics: {summary.get('locationsWithDemographics', 0):,}")
              print(f"- With Accessibility: {summary.get('locationsWithAccessibility', 0):,}")
              print(f"- With Traffic Data: {summary.get('locationsWithTraffic', 0):,}")
              print(f"\n### Coverage")
              print(f"- Demographics: {summary.get('demographicCoverage', 0):.1f}%")
              print(f"- Accessibility: {summary.get('accessibilityCoverage', 0):.1f}%")
              print(f"- Traffic: {summary.get('trafficCoverage', 0):.1f}%")
            EOF
            fi
      - name: Check for data changes
        id: check_changes
        run: |
          if git diff --quiet FranchiseMap/data/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit aggregated data
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Data Aggregation Bot"
          git config user.email "bot@franresearch.com"
          git add FranchiseMap/data/
          git commit -m "chore: update aggregated demographic and traffic data [skip ci]"

      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update aggregated data from pipeline"
          title: "chore: update aggregated demographic and traffic data"
          body: |
            ## Data Aggregation Results

            This PR contains updated demographic, accessibility, and traffic data for all franchise locations.

            ### Generated Files
            - `FranchiseMap/data/data_quality_report.json` - Quality metrics
            - `FranchiseMap/data/dataset_index.json` - Dataset index
            - `FranchiseMap/data/aggregation_results.json` - Pipeline results
            - Updated brand JSON files with enriched location data

            ### Next Steps
            1. Review data quality metrics
            2. Verify no unintended changes
            3. Merge to update map with latest data

            **Auto-generated by Data Aggregation Pipeline**
          branch: data/aggregation-update-${{ github.run_id }}
          delete-branch: true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aggregation-report
          path: |
            FranchiseMap/data/data_quality_report.json
            FranchiseMap/data/dataset_index.json
            FranchiseMap/data/aggregation_results.json
          retention-days: 30

  notify-on-failure:
    needs: aggregate-data
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Data Aggregation Pipeline Failed - Run ${context.runId}`,
              body: `The data aggregation pipeline failed.\n\nCheck the [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['data', 'automation', 'bug']
            })
