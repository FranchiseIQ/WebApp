<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="description" content="FranResearch Sports - Live scores and betting odds for NFL, NBA, WNBA, NHL, MLS, and MLB franchise leagues.">
    <meta name="keywords" content="sports franchises, NFL scores, NBA scores, MLB scores, NHL scores, MLS scores, WNBA scores, betting odds">
    <title>Live Sports Dashboard - FranResearch</title>
    <link rel="icon" href="logo.svg" type="image/svg+xml">

    <!-- Global Styles -->
    <link rel="stylesheet" href="assets/css/global.css">
    <link rel="stylesheet" href="assets/css/layout.css">

    <style>
        :root {
            --bg: #0f172a;
            --card: rgba(255,255,255,0.06);
            --text: #f8fafc;
            --secondary: #cbd5e1;
            --accent1: #6366f1;
            --accent2: #a855f7;
            --live: #ef4444;
            --green: #22c55e;
        }

        /* Light theme */
        [data-theme="light"] {
            --bg: #f8fafc;
            --card: rgba(0,0,0,0.05);
            --text: #0f172a;
            --secondary: #475569;
            --accent1: #4f46e5;
            --accent2: #9333ea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            padding-bottom: 100px;
        }

        /* Global Stock Ticker - Fixed positioning */
        .global-ticker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 300;
            background: #0a0a0a;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .global-ticker iframe {
            width: 100%;
            height: 120px;
            border: none;
            display: block;
            overflow: hidden;
        }

        /* Navigation Bar - Fixed below ticker */
        .main-nav {
            position: fixed;
            top: 120px;
            left: 0;
            width: 100%;
            z-index: 299;
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(15, 23, 42, 0.95);
            padding: 12px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(12px);
            overflow-x: auto;
            box-sizing: border-box;
        }

        .main-nav .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            font-weight: 700;
            font-size: 18px;
            color: var(--text);
            margin-right: auto;
        }

        .main-nav .nav-brand img {
            height: 28px;
            width: auto;
        }

        .main-nav a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            padding: 6px 10px;
            border-radius: 6px;
            transition: color 0.15s, background 0.15s;
        }

        .main-nav a:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.08);
        }

        .main-nav a.active {
            color: var(--accent1);
            background: rgba(99, 102, 241, 0.15);
        }

        /* Franchisor Filter */
        .franchisor-filter {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px 20px;
            background: rgba(0,0,0,0.2);
            align-items: center;
            flex-wrap: wrap;
        }

        .franchisor-filter label {
            font-size: 0.9em;
            color: var(--secondary);
            font-weight: 500;
        }

        .team-filter-dropdown {
            position: relative;
            display: inline-block;
        }

        .team-filter-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            background: #1e293b;
            color: var(--text);
            cursor: pointer;
            min-width: 200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .team-filter-btn:hover {
            background: #334155;
        }

        .team-filter-btn .arrow {
            transition: transform 0.2s;
        }

        .team-filter-btn.open .arrow {
            transform: rotate(180deg);
        }

        .team-filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            width: 280px;
            max-height: 350px;
            overflow-y: auto;
            background: #1e293b;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 100;
            display: none;
            margin-top: 4px;
        }

        .team-filter-menu.open {
            display: block;
        }

        .team-filter-menu .menu-header {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-filter-menu .menu-header button {
            background: transparent;
            border: none;
            color: var(--accent1);
            cursor: pointer;
            font-size: 0.85em;
            padding: 4px 8px;
        }

        .team-filter-menu .menu-header button:hover {
            text-decoration: underline;
        }

        .team-filter-menu .team-group {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .team-filter-menu .team-group:last-child {
            border-bottom: none;
        }

        .team-filter-menu .group-label {
            padding: 6px 12px;
            font-size: 0.75em;
            text-transform: uppercase;
            color: var(--secondary);
            font-weight: 600;
        }

        .team-filter-menu .team-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .team-filter-menu .team-option:hover {
            background: rgba(255,255,255,0.05);
        }

        .team-filter-menu .team-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent1);
            cursor: pointer;
        }

        .team-filter-menu .team-option label {
            cursor: pointer;
            flex: 1;
            font-size: 0.9em;
        }

        .selected-teams-count {
            background: var(--accent1);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Advanced Filters Panel */
        .advanced-filters {
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filters-toggle {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .filters-toggle:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .filters-toggle .arrow {
            transition: transform 0.3s ease;
            font-size: 0.8em;
        }

        .filters-toggle[aria-expanded="true"] .arrow {
            transform: rotate(180deg);
        }

        .filter-actions {
            display: flex;
            gap: 8px;
        }

        .save-filter-btn, .clear-filters-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .save-filter-btn:hover {
            background: var(--accent1);
            border-color: var(--accent1);
        }

        .clear-filters-btn:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        .filters-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .filters-content[aria-hidden="false"] {
            max-height: 600px;
            padding: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.9em;
            color: var(--secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .team-search-input {
            padding: 8px 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--text);
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .team-search-input:focus {
            outline: none;
            background: rgba(255,255,255,0.12);
            border-color: var(--accent1);
        }

        .team-search-input::placeholder {
            color: var(--secondary);
            opacity: 0.7;
        }

        /* Status Filters */
        .status-filters {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .status-checkbox:hover {
            background: rgba(255,255,255,0.05);
        }

        .status-checkbox input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .status-badge {
            font-size: 0.85em;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }

        .status-checkbox input:checked ~ .status-badge {
            border-color: var(--accent1);
        }

        .status-badge.live {
            color: #ef4444;
        }

        .status-badge.upcoming {
            color: #f59e0b;
        }

        .status-badge.final {
            color: #22c55e;
        }

        /* Date Range Filter */
        .date-range {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--text);
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .date-input:focus {
            outline: none;
            background: rgba(255,255,255,0.12);
            border-color: var(--accent1);
        }

        .date-to-label {
            font-size: 0.85em;
            color: var(--secondary);
            flex-shrink: 0;
        }

        /* Saved Presets */
        .presets-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
        }

        .preset-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--accent1);
        }

        .preset-delete {
            background: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 0.9em;
            padding: 2px 6px;
            transition: all 0.2s ease;
        }

        .preset-delete:hover {
            color: #ff6b6b;
        }

        /* Hero Header */
        .sports-hero {
            text-align: center;
            padding: 40px 20px 20px;
            background: linear-gradient(135deg, var(--accent1) 0%, var(--accent2) 100%);
            margin-bottom: 0;
        }

        .sports-hero h1 {
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .sports-hero p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* League Tabs */
        .league-tabs {
            display: flex;
            gap: 10px;
            padding: 20px;
            overflow-x: auto;
            background: rgba(0,0,0,0.3);
            justify-content: center;
            flex-wrap: wrap;
        }

        .league-tabs button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #1e293b;
            color: var(--text);
            white-space: nowrap;
        }

        .league-tabs button:hover {
            background: #334155;
        }

        .league-tabs button.active {
            background: linear-gradient(135deg, var(--accent1) 0%, var(--accent2) 100%);
            color: white;
        }

        .league-tabs button.hidden {
            display: none;
        }

        /* Day Selector */
        .day-selector {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            overflow-x: auto;
            justify-content: center;
            background: rgba(0,0,0,0.2);
        }

        .day-selector button {
            padding: 10px 18px;
            border: 2px solid #334155;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: var(--secondary);
            white-space: nowrap;
        }

        .day-selector button:hover {
            border-color: var(--accent1);
            color: var(--text);
        }

        .day-selector button.active {
            background: var(--accent1);
            border-color: var(--accent1);
            color: white;
        }

        /* Sports Container */
        #sports-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Game Card */
        .game-card {
            background: var(--card);
            padding: 22px;
            border-radius: 14px;
            margin: 22px 0;
            backdrop-filter: blur(14px);
            box-shadow: 0 4px 22px rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .game-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .status-text {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--secondary);
        }

        .status-text.live {
            color: var(--live);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .league-tag {
            background: rgba(99, 102, 241, 0.3);
            color: var(--accent1);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .teams-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .team {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .team:last-child {
            flex-direction: row-reverse;
            text-align: right;
        }

        .team-logo {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            object-fit: contain;
        }

        .team-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .team-name {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text);
        }

        .team-record {
            font-size: 0.85em;
            color: var(--secondary);
        }

        .team-score {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--text);
            min-width: 50px;
            text-align: center;
        }

        .team-score.winner {
            color: var(--green);
        }

        .odds-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 120px;
            text-align: center;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }

        .odds-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
        }

        .odds-row label {
            color: var(--secondary);
        }

        .odds-row span {
            color: var(--text);
            font-weight: 600;
        }

        /* Empty Message */
        .empty-msg {
            text-align: center;
            padding: 60px 20px;
            color: var(--secondary);
        }

        .empty-msg h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--text);
        }

        /* Loading */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent1);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        #site-footer {
            text-align: center;
            padding: 30px 20px;
            background: rgba(0,0,0,0.3);
            margin-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        #site-footer a {
            color: var(--accent1);
            text-decoration: none;
        }

        #site-footer a:hover {
            text-decoration: underline;
        }

        /* Fixed Bottom News Ticker */
        .news-ticker-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 999;
        }

        /* View Toggle (Scores vs Highlights) */
        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(0,0,0,0.15);
        }

        .view-toggle button {
            padding: 8px 20px;
            border: 2px solid #334155;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: var(--secondary);
        }

        .view-toggle button:hover {
            border-color: var(--accent1);
            color: var(--text);
        }

        .view-toggle button.active {
            background: var(--accent1);
            border-color: var(--accent1);
            color: white;
        }

        /* Highlights Section */
        .highlights-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .highlight-card {
            background: var(--card);
            border-radius: 14px;
            overflow: hidden;
            backdrop-filter: blur(14px);
            box-shadow: 0 4px 22px rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .highlight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.35);
            cursor: pointer;
        }

        .highlight-thumbnail {
            position: relative;
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .highlight-thumbnail .team-logos {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .highlight-thumbnail .team-logos img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .highlight-thumbnail .vs-text {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--secondary);
        }

        .highlight-thumbnail .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .highlight-card:hover .play-overlay {
            opacity: 1;
        }

        .play-overlay .play-btn {
            width: 60px;
            height: 60px;
            background: var(--accent1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.5);
        }

        .play-overlay .play-btn::after {
            content: '';
            border-style: solid;
            border-width: 12px 0 12px 20px;
            border-color: transparent transparent transparent white;
            margin-left: 4px;
        }

        .video-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff0000;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .highlight-info {
            padding: 16px;
        }

        .highlight-matchup {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .highlight-teams {
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text);
        }

        .highlight-score {
            font-size: 1.1em;
            font-weight: 800;
            color: var(--green);
        }

        .highlight-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: var(--secondary);
        }

        .highlight-badge {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent1);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .highlight-recap {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9em;
            color: var(--secondary);
            line-height: 1.5;
        }

        /* Video Modal */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .video-modal.open {
            display: flex;
        }

        .video-modal-content {
            position: relative;
            width: 90%;
            max-width: 900px;
            background: #0f172a;
            border-radius: 12px;
            overflow: hidden;
        }

        .video-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: transparent;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            padding: 5px 15px;
        }

        .video-modal-close:hover {
            color: var(--accent1);
        }

        .video-modal-header {
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .video-modal-header h3 {
            margin: 0;
            font-size: 1.1em;
            color: var(--text);
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            background: #000;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Upcoming game card styling */
        .highlight-card.upcoming {
            opacity: 0.9;
        }

        .highlight-card.upcoming .highlight-thumbnail {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .game-time-display {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent1);
            margin-bottom: 4px;
        }

        .network-badge {
            display: inline-block;
            background: rgba(99, 102, 241, 0.3);
            color: var(--accent1);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: var(--secondary);
            text-align: center;
            padding: 20px;
        }

        .video-placeholder h3 {
            color: var(--text);
            margin-bottom: 10px;
        }

        .video-placeholder a {
            color: var(--accent1);
            text-decoration: none;
            margin-top: 15px;
            padding: 10px 20px;
            border: 2px solid var(--accent1);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .video-placeholder a:hover {
            background: var(--accent1);
            color: white;
        }

        .video-placeholder .yt-btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }

        .video-placeholder .yt-btn.primary {
            background: #ff0000;
            color: white;
            border: none;
        }

        .video-placeholder .yt-btn.primary:hover {
            background: #cc0000;
            transform: scale(1.02);
        }

        .video-placeholder .yt-btn.secondary {
            background: transparent;
            color: var(--text);
            border: 2px solid #334155;
        }

        .video-placeholder .yt-btn.secondary:hover {
            border-color: var(--accent1);
            color: var(--accent1);
            background: transparent;
        }

        /* Game Details Drawer */
        .game-details-drawer {
            display: none;
            position: fixed;
            right: -450px;
            top: 0;
            width: 450px;
            height: 100vh;
            background: var(--bg);
            border-left: 1px solid rgba(255,255,255,0.1);
            z-index: 900;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
        }

        .game-details-drawer.open {
            display: block;
            right: 0;
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
        }

        .drawer-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text);
        }

        .drawer-close {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 10px;
        }

        .drawer-close:hover {
            color: var(--accent1);
        }

        .drawer-content {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h3 {
            font-size: 0.95em;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--secondary);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .odds-breakdown {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .odds-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .odds-item:last-child {
            margin-bottom: 0;
        }

        .odds-label {
            color: var(--secondary);
        }

        .odds-value {
            color: var(--text);
            font-weight: 600;
        }

        .weather-section {
            background: rgba(99, 102, 241, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--accent1);
        }

        .weather-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .weather-item:last-child {
            margin-bottom: 0;
        }

        .players-list {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            overflow: hidden;
        }

        .player-item {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9em;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-name {
            font-weight: 600;
            color: var(--text);
        }

        .player-meta {
            color: var(--secondary);
            font-size: 0.85em;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--live);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
            margin-right: 6px;
        }

        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 850;
        }

        .drawer-overlay.open {
            display: block;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 900;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .settings-modal.open {
            display: flex;
        }

        .settings-panel {
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(40, 40, 70, 0.95));
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(20px);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out forwards;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        .settings-header h2 {
            font-size: 1.3em;
            color: var(--text);
            margin: 0;
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--secondary);
            font-size: 1.5em;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .settings-close:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }

        .settings-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-section h3 {
            font-size: 0.95em;
            text-transform: uppercase;
            color: var(--accent1);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin: 0;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }

        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
            font-size: 0.9em;
            flex: 1;
        }

        .settings-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent1);
        }

        .settings-select,
        .settings-input {
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9em;
            font-family: inherit;
            flex: 1;
            transition: all 0.2s;
        }

        .settings-select:hover,
        .settings-input:hover {
            border-color: var(--accent1);
            background: rgba(0,0,0,0.4);
        }

        .settings-select:focus,
        .settings-input:focus {
            outline: none;
            border-color: var(--accent1);
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.3);
        }

        .team-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .team-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .team-checkbox:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent1);
        }

        .team-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent1);
        }

        .team-checkbox label {
            cursor: pointer;
            color: var(--text);
            font-size: 0.85em;
        }

        .settings-footer {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        .settings-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-btn-save {
            background: var(--accent1);
            color: white;
        }

        .settings-btn-save:hover {
            background: var(--accent2);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .settings-btn-reset {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .settings-btn-reset:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .settings-btn:active {
            transform: scale(0.98);
        }

        /* Settings button in navbar */
        .settings-btn-nav {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.2em;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .settings-btn-nav:hover {
            color: var(--text);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Notification Center */
        .notification-btn-nav {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.2em;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .notification-btn-nav:hover {
            color: var(--text);
            background: rgba(99, 102, 241, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65em;
            font-weight: 700;
        }

        /* Notification Center Panel */
        .notification-center {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: var(--bg);
            border-left: 1px solid rgba(255,255,255,0.1);
            z-index: 500;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
        }

        .notification-center.open {
            right: 0;
        }

        .notification-center-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .notification-center-header h2 {
            font-size: 1.1em;
            margin: 0;
        }

        .notification-center-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-center-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        .notification-clear-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .notification-clear-btn:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            gap: 12px;
        }

        .notification-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .notification-item.new {
            background: rgba(99, 102, 241, 0.05);
            border-left: 3px solid var(--accent1);
        }

        .notification-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 4px;
            color: var(--text);
        }

        .notification-message {
            font-size: 0.85em;
            color: var(--secondary);
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .notification-time {
            font-size: 0.75em;
            color: var(--secondary);
            opacity: 0.7;
        }

        .notification-remove {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            font-size: 1.1em;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .notification-remove:hover {
            color: #ef4444;
            opacity: 1;
        }

        .notification-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--secondary);
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(99, 102, 241, 0.3);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent1);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }

        /* Toast animations */
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Responsive */
        /* ========== RESPONSIVE DESIGN ========== */

        /* Mobile First: Styles for screens 480px and below */
        @media (max-width: 480px) {
            /* Adjust padding for smaller screens */
            body {
                padding-top: 160px; /* Reduced from 170px */
                padding-bottom: 80px; /* Reduced from 100px */
            }

            /* Navigation adjustments */
            .main-nav {
                padding: 10px 12px;
                gap: 10px;
            }

            .nav-brand img {
                height: 24px;
            }

            /* Game grid - single column on mobile */
            .highlights-grid {
                grid-template-columns: 1fr;
                padding: 12px;
                gap: 12px;
            }

            /* Game cards compact */
            .highlight-card {
                border-radius: 8px;
            }

            .highlight-info {
                padding: 10px;
            }

            .highlight-teams {
                font-size: 0.9em;
            }

            .highlight-meta {
                font-size: 0.8em;
                gap: 8px;
            }

            /* Drawer optimizations for mobile */
            .game-details-drawer {
                width: 100%;
                height: 90vh;
                top: auto;
                bottom: 0;
                border-radius: 12px 12px 0 0;
                max-height: 90vh;
                animation: slideUpMobile 0.3s ease-out forwards;
            }

            .game-details-drawer.open {
                bottom: 0;
            }

            @keyframes slideUpMobile {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .drawer-content {
                max-height: calc(90vh - 60px);
                overflow-y: auto;
                padding: 16px 12px;
            }

            /* Ticker adjustments */
            .sports-ticker {
                height: 50px;
                padding: 0;
            }

            .ticker-item {
                font-size: 0.75em;
                padding: 4px 8px;
                gap: 8px;
            }

            .ticker-item-teams {
                flex-direction: column;
                gap: 2px;
            }

            .ticker-item-score {
                margin: 0 4px;
            }

            /* Hide secondary info on very small screens */
            .highlight-meta span:last-child {
                display: none;
            }

            /* Adjust league tabs */
            .league-tabs {
                overflow-x: auto;
                padding: 8px;
                gap: 4px;
                justify-content: flex-start;
            }

            .league-tabs button {
                padding: 6px 12px;
                font-size: 0.85em;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Team filter adjustments */
            .filter-button {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            /* Detail section responsiveness */
            .detail-section h3 {
                font-size: 1em;
                margin-bottom: 12px;
            }

            .weather-item {
                padding: 8px 0;
                font-size: 0.85em;
            }

            /* Prediction panel - stack vertically on mobile */
            .prediction-section {
                grid-template-columns: 1fr !important;
            }

            /* Team comparison - vertical layout on mobile */
            .team-comparison-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* Tablet: Styles for screens 481px - 768px */
        @media (min-width: 481px) and (max-width: 768px) {
            body {
                padding-top: 165px;
                padding-bottom: 90px;
            }

            .highlights-grid {
                grid-template-columns: 1fr;
                padding: 16px;
                gap: 14px;
            }

            .game-details-drawer {
                width: 100%;
                height: 85vh;
                top: auto;
                bottom: 0;
                border-radius: 12px 12px 0 0;
                animation: slideUpMobile 0.3s ease-out forwards;
            }

            .drawer-content {
                max-height: calc(85vh - 60px);
                padding: 16px;
            }

            .sports-ticker {
                height: 55px;
            }

            .league-tabs {
                padding: 10px;
                gap: 6px;
            }

            .league-tabs button {
                padding: 7px 14px;
                font-size: 0.9em;
            }

            /* Better use of tablet width */
            .team-comparison-grid {
                grid-template-columns: 1fr 1fr;
            }

            .prediction-section {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Original 768px media query - keep for backwards compatibility */
        @media (max-width: 768px) {
            .sports-hero h1 {
                font-size: 1.8em;
            }

            .teams-row {
                flex-direction: column;
                gap: 15px;
            }

            .team, .team:last-child {
                flex-direction: row;
                text-align: left;
                width: 100%;
                justify-content: space-between;
            }

            .odds-column {
                width: 100%;
            }

            .league-tabs {
                justify-content: flex-start;
            }

            .highlight-thumbnail .team-logos img {
                width: 50px;
                height: 50px;
            }
        }

        /* Desktop: Styles for screens 769px and above */
        @media (min-width: 769px) and (max-width: 1024px) {
            /* Tablet landscape - 2 columns */
            .highlights-grid {
                grid-template-columns: repeat(2, 1fr);
                max-width: 900px;
                margin: 0 auto;
            }

            /* Drawer positioning for desktop */
            .game-details-drawer {
                width: 420px;
                height: auto;
                max-height: 85vh;
                top: 50%;
                right: 20px;
                bottom: auto;
                transform: translateY(-50%);
                border-radius: 12px;
            }

            .game-details-drawer.open {
                right: 20px;
            }
        }

        /* Large Desktop: 1025px and above */
        @media (min-width: 1025px) {
            /* 3-column grid on desktop */
            .highlights-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                max-width: 1200px;
                margin: 0 auto;
            }

            /* Drawer on the right */
            .game-details-drawer {
                width: 450px;
                height: auto;
                max-height: 90vh;
                top: 50%;
                right: 30px;
                bottom: auto;
                transform: translateY(-50%);
                border-radius: 12px;
            }

            .game-details-drawer.open {
                right: 30px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Increase touch target sizes */
            button, .league-tabs button, .filter-button {
                min-height: 44px;
                min-width: 44px;
                padding: 10px 16px;
            }

            /* Remove hover effects on touch devices */
            .league-tabs button:hover {
                border-color: inherit;
                color: inherit;
            }

            /* Improve card tap targets */
            .highlight-card {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(99, 102, 241, 0.2);
            }

            /* Better touch scrolling */
            .drawer-content {
                -webkit-overflow-scrolling: touch;
            }

            .sports-ticker-container {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding-top: 130px;
                padding-bottom: 60px;
            }

            .game-details-drawer {
                max-height: 85vh;
            }

            .sports-ticker {
                height: 45px;
            }

            .main-nav {
                padding: 8px 12px;
            }
        }
        }

        /* Sports Headlines Ticker */
        .sports-ticker {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(90deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            border-top: 2px solid var(--accent1);
            z-index: 200;
            display: flex;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        .sports-ticker-container {
            display: flex;
            gap: 30px;
            padding: 8px 20px;
            animation: scrollRight 30s linear infinite;
            white-space: nowrap;
            will-change: transform;
        }

        .sports-ticker-container:hover {
            animation-play-state: paused;
        }

        @keyframes scrollRight {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100vw);
            }
        }

        .ticker-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            font-size: 0.85em;
            border: 1px solid rgba(99, 102, 241, 0.3);
            flex-shrink: 0;
        }

        .ticker-item-teams {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .ticker-item-score {
            font-weight: 700;
            color: var(--accent1);
            margin: 0 6px;
        }

        .ticker-item-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 6px;
        }

        .ticker-status-live {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            animation: pulse-red 1.5s ease-in-out infinite;
        }

        .ticker-status-final {
            background: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .ticker-status-upcoming {
            background: rgba(99, 102, 241, 0.3);
            color: #6366f1;
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body class="has-fixed-ticker has-fixed-nav">
    <!-- Global Stock Ticker -->
    <div class="global-ticker">
        <iframe src="Website/ticker.html?embed=true" title="Franchise stock ticker" loading="eager" scrolling="no"></iframe>
    </div>

    <!-- Navigation Bar -->
    <nav class="main-nav">
        <a href="index.html" class="nav-brand">
            <img src="logo.svg" alt="FranResearch">
            <span>FranResearch</span>
        </a>
        <a href="Website/ticker.html">Ticker</a>
        <a href="StockChart/chart.html">Charts</a>
        <a href="FranchiseMap/map.html">Map</a>
        <a href="FranchiseNews/news-feed.html">News</a>
        <a href="sports.html" class="active">Sports</a>
        <a href="franchise_calculators_module/index.html">Calculators</a>
        <a href="about.html">About</a>
        <button class="notification-btn-nav" id="notification-btn" onclick="openNotificationCenter()" title="Notifications">
            
            <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
        </button>
        <button class="notification-btn-nav" id="analytics-btn" onclick="openAnalyticsDashboard()" title="Analytics">
            
        </button>
        <button class="settings-btn-nav" onclick="openSettings()" title="Preferences"></button>
    </nav>

    <!-- Hero Header -->
    <header class="sports-hero">
        <h1>Live Sports Dashboard</h1>
        <p>Real-time franchise league scores and betting odds</p>
    </header>

    <!-- League Tabs -->
    <nav class="league-tabs" id="league-tabs">
        <button data-league="NFL" class="active">NFL</button>
        <button data-league="NBA">NBA</button>
        <button data-league="WNBA">WNBA</button>
        <button data-league="NHL">NHL</button>
        <button data-league="MLS">MLS</button>
        <button data-league="MLB">MLB</button>
    </nav>

    <!-- Advanced Filters Panel -->
    <div class="advanced-filters">
        <div class="filters-header">
            <button class="filters-toggle" id="filters-toggle" title="Toggle Filters">
                <span> Filters</span>
                <span class="arrow"></span>
            </button>
            <div class="filter-actions">
                <button class="save-filter-btn" id="save-filter-btn" title="Save current filters"> Save</button>
                <button class="clear-filters-btn" id="clear-filters-btn" title="Clear all filters"> Clear</button>
            </div>
        </div>

        <div class="filters-content" id="filters-content">
            <!-- Team Search -->
            <div class="filter-group">
                <label>Find Team:</label>
                <input type="text" id="team-search" placeholder="Search teams..." class="team-search-input">
            </div>

            <!-- Game Status Filter -->
            <div class="filter-group">
                <label>Game Status:</label>
                <div class="status-filters">
                    <label class="status-checkbox">
                        <input type="checkbox" name="game-status" value="LIVE" id="filter-live">
                        <span class="status-badge live"> Live</span>
                    </label>
                    <label class="status-checkbox">
                        <input type="checkbox" name="game-status" value="UPCOMING" id="filter-upcoming">
                        <span class="status-badge upcoming"> Upcoming</span>
                    </label>
                    <label class="status-checkbox">
                        <input type="checkbox" name="game-status" value="FINAL" id="filter-final">
                        <span class="status-badge final"> Final</span>
                    </label>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="filter-group">
                <label>Date Range:</label>
                <div class="date-range">
                    <input type="date" id="filter-date-from" class="date-input" title="Start date">
                    <span class="date-to-label">to</span>
                    <input type="date" id="filter-date-to" class="date-input" title="End date">
                </div>
            </div>

            <!-- Team Filter -->
            <div class="filter-group">
                <label>Filter by Team:</label>
                <div class="team-filter-dropdown" id="team-filter-dropdown">
                    <button class="team-filter-btn" id="team-filter-btn">
                        <span id="filter-btn-text">All Teams</span>
                        <span class="arrow">&#9662;</span>
                    </button>
                    <div class="team-filter-menu" id="team-filter-menu">
                        <div class="menu-header">
                            <span>Select Teams</span>
                            <div>
                                <button id="select-all-teams">Select All</button>
                                <button id="clear-all-teams">Clear</button>
                            </div>
                        </div>
                        <div id="team-checkboxes"></div>
                    </div>
                </div>
            </div>

            <!-- Saved Filter Presets -->
            <div class="filter-group" id="saved-presets-group" style="display: none;">
                <label>Saved Presets:</label>
                <div class="presets-list" id="presets-list"></div>
            </div>
        </div>
    </div>

    <!-- Franchisor Filter (Kept for backward compatibility) -->
    <div class="franchisor-filter" style="display: none;">
        <label>Filter by Team:</label>
        <div class="team-filter-dropdown" id="team-filter-dropdown">
            <button class="team-filter-btn" id="team-filter-btn">
                <span id="filter-btn-text">All Teams</span>
                <span class="arrow">&#9662;</span>
            </button>
            <div class="team-filter-menu" id="team-filter-menu">
                <div class="menu-header">
                    <span>Select Teams</span>
                    <div>
                        <button id="select-all-teams">Select All</button>
                        <button id="clear-all-teams">Clear</button>
                    </div>
                </div>
                <div id="team-checkboxes"></div>
            </div>
        </div>
    </div>

    <!-- Day Selector -->
    <div class="day-selector" id="day-selector"></div>

    <!-- Unified Games Grid (All games - completed and upcoming) -->
    <section class="highlights-container" id="games-container">
        <div class="highlights-grid" id="games-grid">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading sports data...</p>
            </div>
        </div>
    </section>

    <!-- Video Modal - Simple iframe like test page -->
    <div class="video-modal" id="video-modal">
        <div class="video-modal-content">
            <button class="video-modal-close" onclick="closeVideoModal()">&times;</button>
            <div class="video-modal-header">
                <h3 id="modal-title">Game Highlights</h3>
            </div>
            <div class="video-container">
                <iframe id="video-iframe" src="" allowfullscreen
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="site-footer">
        <p>&copy; 2024 FranResearch Sports. <a href="index.html">Back to Main Site</a></p>
        <p style="margin-top: 10px; font-size: 0.9em; color: var(--secondary);">
            Data provided by ESPN | Updates every 60 seconds
        </p>
    </footer>

    <!-- Fixed Bottom News Ticker -->
    <div id="franchise-news-ticker-bottom" class="news-ticker-bottom"></div>

    <!-- Sports Headlines Ticker -->
    <div class="sports-ticker" id="sports-ticker">
        <div class="sports-ticker-container" id="sports-ticker-container">
            <!-- Game items will be populated here -->
        </div>
    </div>

    <!-- Game Details Drawer -->
    <div class="drawer-overlay" id="drawer-overlay"></div>
    <div class="game-details-drawer" id="game-details-drawer">
        <div class="drawer-header">
            <h2 id="drawer-matchup">Game Details</h2>
            <button class="drawer-close" onclick="closeGameDrawer()">&times;</button>
        </div>
        <div class="drawer-content" id="drawer-content">
            <!-- Content populated dynamically -->
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-panel">
            <div class="settings-header">
                <h2>Preferences</h2>
                <button class="settings-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="settings-content">
                <!-- Favorite Leagues -->
                <div class="settings-section">
                    <h3>Favorite Leagues</h3>
                    <div class="team-checkboxes" id="league-checkboxes">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Favorite Teams -->
                <div class="settings-section">
                    <h3>Favorite Teams</h3>
                    <div class="team-checkboxes" id="team-checkboxes">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Notifications -->
                <div class="settings-section">
                    <h3>Notifications</h3>
                    <div class="settings-item">
                        <label class="settings-label">Enable Notifications</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notify-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <label class="settings-label">Notification Sound</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notify-sound">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="color: var(--secondary); font-size: 0.9em; flex: 1;">Quiet Hours</label>
                        <select class="settings-select" id="quiet-start" style="flex: 0.8;">
                            <!-- Hours 0-23 -->
                        </select>
                        <span style="color: var(--secondary);">to</span>
                        <select class="settings-select" id="quiet-end" style="flex: 0.8;">
                            <!-- Hours 0-23 -->
                        </select>
                    </div>
                </div>

                <!-- Theme & View -->
                <div class="settings-section">
                    <h3>Display</h3>
                    <div class="settings-item">
                        <label class="settings-label">Time Zone</label>
                        <select class="settings-select" id="timezone-select">
                            <option value="America/New_York">Eastern (EST/EDT)</option>
                            <option value="America/Chicago">Central (CST/CDT)</option>
                            <option value="America/Denver">Mountain (MST/MDT)</option>
                            <option value="America/Los_Angeles">Pacific (PST/PDT)</option>
                            <option value="UTC">UTC</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <label class="settings-label">Theme</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle" data-theme-toggle>
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="font-size: 0.85em; color: var(--secondary); margin-left: 8px;">
                            <span id="theme-label">Dark</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="settings-btn settings-btn-save" onclick="saveSettings()">Save Preferences</button>
                <button class="settings-btn settings-btn-reset" onclick="resetSettings()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <!-- Notification Center Panel -->
    <div class="notification-center" id="notification-center">
        <div class="notification-center-header">
            <h2>Notifications</h2>
            <button class="notification-center-close" onclick="closeNotificationCenter()"></button>
        </div>
        <div class="notification-center-actions">
            <button class="notification-clear-btn" onclick="clearAllNotifications()">Clear All</button>
        </div>
        <div class="notification-list" id="notification-list">
            <div class="notification-empty">No notifications yet</div>
        </div>
    </div>

    <!-- Analytics Dashboard Panel -->
    <div class="notification-center" id="analytics-dashboard">
        <div class="notification-center-header">
            <h2>Analytics</h2>
            <button class="notification-center-close" onclick="closeAnalyticsDashboard()"></button>
        </div>
        <div class="notification-center-actions">
            <button class="notification-clear-btn" onclick="clearAnalyticsHistory()">Clear History</button>
        </div>
        <div style="padding: 16px; overflow-y: auto; flex: 1;">
            <div id="analytics-content">
                <div class="notification-empty">Loading analytics...</div>
            </div>
        </div>
    </div>

    <!-- News Widget Scripts -->
    <script src="FranchiseNews/newsService.js"></script>
    <script src="FranchiseNews/news-widget.js"></script>

    <script>
        // League configuration with local data files
        const LEAGUES = {
            NFL: { dataUrl: 'data/football/current-week.json', icon: '', leagueFilter: 'NFL' },
            NBA: { dataUrl: 'data/basketball/current-games.json', icon: '', leagueFilter: 'NBA' },
            WNBA: { dataUrl: 'data/basketball/current-games.json', icon: '', leagueFilter: 'WNBA' },
            NHL: { dataUrl: 'data/hockey/current-games.json', icon: '', leagueFilter: 'NHL' },
            MLS: { dataUrl: 'data/soccer/current-games.json', icon: '', leagueFilter: 'MLS' },
            MLB: { dataUrl: 'data/baseball/current-games.json', icon: '', leagueFilter: 'MLB' }
        };

        // Betting odds configuration (supports The Odds API, API-Sports, etc.)
        const ODDS_CONFIG = {
            apiKey: null, // Set this to your API key for real odds (from The Odds API, API-Sports, etc.)
            provider: 'the-odds-api', // Options: 'the-odds-api', 'api-sports'
            cache: {}  // Cache odds by game ID to reduce API calls
        };

        // Sample betting odds (fallback when real API not available)
        const SAMPLE_ODDS = {
            spreads: [-3.5, -7, -2.5, 3, -1, 6.5, -4, 2, -6, 1.5],
            totals: [44.5, 47, 41.5, 52, 48.5, 45, 50.5, 43, 49, 46.5]
        };

        // NFL Stadium coordinates for weather API integration
        const NFL_STADIUMS = {
            'Arrowhead Stadium': { lat: 39.0489, lon: -94.4840, city: 'Kansas City' },
            'Acrisure Stadium': { lat: 40.4465, lon: -80.0157, city: 'Pittsburgh' },
            'Allegiant Stadium': { lat: 36.0897, lon: -115.1813, city: 'Las Vegas' },
            'Caesars Superdome': { lat: 29.9510, lon: -90.0810, city: 'New Orleans' },
            'Cleveland Browns Stadium': { lat: 41.5061, lon: -81.6996, city: 'Cleveland' },
            'Empower Field at Mile High': { lat: 39.7439, lon: -104.9009, city: 'Denver' },
            'Gillette Stadium': { lat: 42.0909, lon: -71.2643, city: 'Foxborough' },
            'Hard Rock Stadium': { lat: 26.0618, lon: -80.2389, city: 'Miami Gardens' },
            'Highmark Stadium': { lat: 42.7736, lon: -78.7870, city: 'Orchard Park' },
            'Huntington Bank Field': { lat: 41.5061, lon: -81.6996, city: 'Cleveland' },
            'Levi\'s Stadium': { lat: 37.4049, lon: -122.0574, city: 'Santa Clara' },
            'Lucas Oil Stadium': { lat: 39.7605, lon: -86.1643, city: 'Indianapolis' },
            'MetLife Stadium': { lat: 40.8134, lon: -74.0747, city: 'East Rutherford' },
            'Mercedes-Benz Superdome': { lat: 29.9510, lon: -90.0810, city: 'New Orleans' },
            'Paycor Stadium': { lat: 39.0957, lon: -84.5164, city: 'Cincinnati' },
            'SoFi Stadium': { lat: 33.9536, lon: -118.3391, city: 'Inglewood' },
            'Soldier Field': { lat: 41.8623, lon: -87.6167, city: 'Chicago' },
            'State Farm Stadium': { lat: 33.7574, lon: -112.2627, city: 'Glendale' },
            'Arrowhead Stadium': { lat: 39.0489, lon: -94.4840, city: 'Kansas City' },
            'FedEx Forum': { lat: 35.1382, lon: -90.0065, city: 'Memphis' },
            'Lamp Field': { lat: 42.0909, lon: -71.2643, city: 'Foxborough' },
            'Lincoln Financial Field': { lat: 39.9012, lon: -75.1673, city: 'Philadelphia' },
            'Lambeau Field': { lat: 44.5013, lon: -88.0622, city: 'Green Bay' },
            'AT&T Stadium': { lat: 32.7479, lon: -97.0939, city: 'Arlington' },
            'Lumen Field': { lat: 47.5951, lon: -122.3316, city: 'Seattle' },
            'Raymond James Stadium': { lat: 27.9759, lon: -82.5033, city: 'Tampa' },
            'Nissan Stadium': { lat: 36.1627, lon: -86.7816, city: 'Nashville' },
            'U.S. Bank Stadium': { lat: 44.9745, lon: -93.2618, city: 'Minneapolis' },
            'Caesars Superdome': { lat: 29.9510, lon: -90.0810, city: 'New Orleans' },
            'FedExForum': { lat: 35.1382, lon: -90.0065, city: 'Memphis' },
            'Acrisure Stadium': { lat: 40.4465, lon: -80.0157, city: 'Pittsburgh' },
            'Lumen Field': { lat: 47.5951, lon: -122.3316, city: 'Seattle' },
            'SoFi Stadium': { lat: 33.9536, lon: -118.3391, city: 'Inglewood' },
            'Arrowhead Stadium': { lat: 39.0489, lon: -94.4840, city: 'Kansas City' },
            'M&T Bank Stadium': { lat: 39.2782, lon: -76.6225, city: 'Baltimore' },
            'Washington Commanders Stadium': { lat: 38.9076, lon: -77.1007, city: 'Landover' },
            'FedExForum': { lat: 35.1382, lon: -90.0065, city: 'Memphis' }
        };

        // Weather cache to avoid repeated API calls
        let weatherCache = {};
        let currentLeague = 'NFL'; // Current league being viewed
        let currentWeek = null; // Will be set to the current week
        let gamesCache = {};
        let allGames = [];
        let selectedTeams = new Set(); // Empty = show all teams
        let videoUrlCache = {}; // Cache for YouTube video URLs from unified data

        // ESPN highlight URLs by league (fallback)
        const ESPN_HIGHLIGHTS = {
            NFL: 'https://www.espn.com/nfl/scoreboard',
            NBA: 'https://www.espn.com/nba/scoreboard',
            NHL: 'https://www.espn.com/nhl/scoreboard',
            MLB: 'https://www.espn.com/mlb/scoreboard',
            MLS: 'https://www.espn.com/soccer/scoreboard/_/league/usa.1',
            WNBA: 'https://www.espn.com/wnba/scoreboard'
        };

        // YouTube channel IDs for official league highlights
        const YOUTUBE_CHANNELS = {
            NFL: 'UCDVYQ4Zhbm3S2dlz7P1GBDg',  // NFL official
            NBA: 'UCWJ2lWNubArHWmf3FIHbfcQ',  // NBA official
            NHL: 'UCqFMzb-4AUf6WAIbl132QKA',  // NHL official
            MLB: 'UCoLrcjPV5PbUrUyXq5mjc_A',  // MLB official
            MLS: 'UCSZbXT5TLLW_i-5W8FZpFsg',  // MLS official
            WNBA: 'UCJm4Yt-5hzFqbfGH2xbIZWA'  // WNBA official
        };

        // Game recap templates based on score differential
        const RECAP_TEMPLATES = {
            blowout: [
                '{winner} dominated {loser} in a commanding {winScore}-{loseScore} victory.',
                '{winner} cruised to an easy win over {loser}, {winScore}-{loseScore}.',
                'A dominant performance by {winner} as they routed {loser} {winScore}-{loseScore}.'
            ],
            close: [
                '{winner} edged out {loser} in a thriller, {winScore}-{loseScore}.',
                'A nail-biter finish as {winner} held off {loser} {winScore}-{loseScore}.',
                '{winner} survived a close contest against {loser}, winning {winScore}-{loseScore}.'
            ],
            normal: [
                '{winner} defeated {loser} {winScore}-{loseScore}.',
                '{winner} took down {loser} with a {winScore}-{loseScore} victory.',
                'Final: {winner} {winScore}, {loser} {loseScore}.'
            ]
        };

        // Format time to 12-hour EST
        function formatTimeEST(isoString) {
            if (!isoString) return 'TBD';

            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return 'TBD';

                const options = {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true,
                    timeZone: 'America/New_York'
                };

                return date.toLocaleTimeString('en-US', options) + ' EST';
            } catch (e) {
                return 'TBD';
            }
        }

        // Format date for display
        function formatDateShort(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }

        // Get date string for comparison
        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }

        // Determine if week is playoff based on week number
        function isPlayoffWeek(week) {
            return week > 18;
        }

        // Get playoff week name
        function getPlayoffWeekName(week) {
            const playoffWeeks = {
                19: 'Wild Card',
                20: 'Divisional',
                21: 'Conference',
                22: 'Super Bowl'
            };
            return playoffWeeks[week] || `Week ${week}`;
        }

        // Get week label for display
        function getWeekLabel(week) {
            if (!week) return 'TBD';
            if (isPlayoffWeek(week)) {
                return getPlayoffWeekName(week);
            }
            return `Week ${week}`;
        }

        // Generate week selector buttons (NFL only, other sports don't use weeks)
        function generateWeekSelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = '';

            // Only NFL uses weeks - other sports show all games
            if (currentLeague !== 'NFL') {
                return;
            }

            // Get all available weeks from games
            const availableWeeks = new Set();
            allGames.forEach(game => {
                if (game.week) availableWeeks.add(game.week);
            });

            // For NFL, show all 18 regular season weeks + playoffs
            // Even if some weeks don't have data yet
            const allRegularSeasonWeeks = Array.from({length: 18}, (_, i) => i + 1);
            const allPlayoffWeeks = [19, 20, 21, 22]; // Wild Card, Divisional, Conference, Super Bowl

            // Set current week to the latest available week if not set
            if (currentWeek === null) {
                const sortedWeeks = Array.from(availableWeeks).sort((a, b) => a - b);
                currentWeek = sortedWeeks.length > 0 ? sortedWeeks[sortedWeeks.length - 1] : 1;
            }

            // Create buttons for all regular season weeks
            allRegularSeasonWeeks.forEach(week => {
                const btn = document.createElement('button');
                btn.textContent = `Week ${week}`;
                btn.dataset.week = week;
                if (week === currentWeek) btn.classList.add('active');

                // Disable weeks with no data (show different style)
                if (!availableWeeks.has(week)) {
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.disabled = true;
                }

                btn.addEventListener('click', () => {
                    if (!btn.disabled) {
                        document.querySelectorAll('.day-selector button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentWeek = week;
                        renderGames();
                    }
                });

                container.appendChild(btn);
            });

            // Add divider if both regular season and playoffs
            if (availableWeeks.size > 0) {
                const divider = document.createElement('div');
                divider.style.cssText = 'width: 2px; background: rgba(255,255,255,0.2); margin: 0 10px;';
                container.appendChild(divider);
            }

            // Create buttons for playoff weeks
            allPlayoffWeeks.forEach(week => {
                const btn = document.createElement('button');
                btn.textContent = getPlayoffWeekName(week);
                btn.dataset.week = week;
                if (week === currentWeek) btn.classList.add('active');

                // Disable playoff weeks with no data
                if (!availableWeeks.has(week)) {
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.disabled = true;
                }

                btn.addEventListener('click', () => {
                    if (!btn.disabled) {
                        document.querySelectorAll('.day-selector button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentWeek = week;
                        renderGames();
                    }
                });

                container.appendChild(btn);
            });
        }

        // Load video URLs from unified sports_data.json (created by GitHub Actions)
        async function loadVideoUrls() {
            if (Object.keys(videoUrlCache).length > 0) return; // Already loaded

            try {
                // Add timeout to fetch (3 seconds)
                const fetchWithTimeout = (url, timeout = 3000) => {
                    return Promise.race([
                        fetch(url),
                        new Promise((_, reject) =>
                            setTimeout(() => reject(new Error('Fetch timeout')), timeout)
                        )
                    ]);
                };

                const response = await fetchWithTimeout(`sports_data.json?t=${Date.now()}`, 3000);
                if (!response.ok) return;

                const data = await response.json();
                console.log('Loaded video URLs from sports_data.json:', data.last_updated);

                // Build cache of video URLs by team matchup for ALL sports
                ['nfl', 'nba', 'wnba', 'nhl', 'mlb', 'mls'].forEach(league => {
                    const leagueData = data[league];
                    if (leagueData?.games) {
                        leagueData.games.forEach(game => {
                            if (game.video_url) {
                                // Create key from team names
                                const away = game.awayTeam?.shortName || game.awayTeam?.name || '';
                                const home = game.homeTeam?.shortName || game.homeTeam?.name || '';
                                if (away && home) {
                                    const key = `${away.toLowerCase()}_${home.toLowerCase()}`;
                                    videoUrlCache[key] = game.video_url;
                                }
                            }
                        });
                    }
                });

                console.log(`Cached ${Object.keys(videoUrlCache).length} video URLs`);
            } catch (error) {
                console.log('No unified video data available yet:', error.message);
            }
        }

        // Get video URL for a game from cache
        function getVideoUrl(awayTeam, homeTeam) {
            const away = (awayTeam?.shortName || awayTeam?.name || '').toLowerCase();
            const home = (homeTeam?.shortName || homeTeam?.name || '').toLowerCase();
            return videoUrlCache[`${away}_${home}`] || null;
        }

        // Enrich games with video URLs from cache
        function enrichGamesWithVideoUrls(games) {
            return games.map(game => {
                if (!game.video_url) {
                    const cachedUrl = getVideoUrl(game.awayTeam, game.homeTeam);
                    if (cachedUrl) {
                        game.video_url = cachedUrl;
                    }
                }
                return game;
            });
        }

        // Fetch games from local JSON files
        async function fetchGames(league) {
            const config = LEAGUES[league];
            if (!config) return [];

            const cacheKey = `${league}-data`;
            if (gamesCache[cacheKey]) {
                return gamesCache[cacheKey];
            }

            try {
                // Add timeout to fetch (5 seconds)
                const fetchWithTimeout = (url, timeout = 5000) => {
                    return Promise.race([
                        fetch(url),
                        new Promise((_, reject) =>
                            setTimeout(() => reject(new Error('Fetch timeout')), timeout)
                        )
                    ]);
                };

                const response = await fetchWithTimeout(config.dataUrl, 5000);
                if (!response.ok) {
                    console.warn(`No data file for ${league}`);
                    return [];
                }

                const data = await response.json();
                let games = data?.games || [];

                // Filter by league if needed (e.g., NCAA vs NFL in football data)
                if (config.leagueFilter) {
                    games = games.filter(g => g.league === config.leagueFilter);
                }

                gamesCache[cacheKey] = games;
                return games;
            } catch (error) {
                console.error(`Error fetching ${league} games:`, error.message);
                return [];
            }
        }

        // Get random odds for a game (simulated - in production use real odds API)
        // Fetch real odds from API (if configured) or use sample odds
        async function getGameOdds(gameId, awayTeamName, homeTeamName) {
            // Check cache first
            if (ODDS_CONFIG.cache[gameId]) {
                return ODDS_CONFIG.cache[gameId];
            }

            let odds = null;

            // Try real API if configured
            if (ODDS_CONFIG.apiKey && ODDS_CONFIG.provider === 'the-odds-api') {
                try {
                    // The Odds API endpoint for upcoming games
                    const response = await fetch(
                        `https://api.the-odds-api.com/v4/sports/americanfootball_nfl/events?apiKey=${ODDS_CONFIG.apiKey}`,
                        { timeout: 5000 }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        // Find matching game
                        const game = data.data?.find(g =>
                            g.name.includes(awayTeamName) && g.name.includes(homeTeamName)
                        );
                        if (game && game.bookmakers && game.bookmakers.length > 0) {
                            // Get spreads from first available bookmaker
                            const markets = game.bookmakers[0].markets || [];
                            const spreadMarket = markets.find(m => m.key === 'spreads');
                            const totalMarket = markets.find(m => m.key === 'totals');

                            if (spreadMarket && totalMarket) {
                                odds = {
                                    spread: parseFloat(spreadMarket.outcomes[0]?.point || -3),
                                    total: parseFloat(totalMarket.outcomes[0]?.point || 45)
                                };
                            }
                        }
                    }
                } catch (error) {
                    console.log('Odds API fetch failed, using sample odds:', error.message);
                }
            }

            // Fall back to sample odds
            if (!odds) {
                const hash = gameId.split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0);
                const spreadIdx = Math.abs(hash) % SAMPLE_ODDS.spreads.length;
                const totalIdx = Math.abs(hash >> 4) % SAMPLE_ODDS.totals.length;
                odds = {
                    spread: SAMPLE_ODDS.spreads[spreadIdx],
                    total: SAMPLE_ODDS.totals[totalIdx]
                };
            }

            // Cache the result
            ODDS_CONFIG.cache[gameId] = odds;
            return odds;
        }

        // Normalize game status - uses multiple data points for accuracy
        function normalizeStatus(game) {
            const status = (game.status || '').toLowerCase();
            const now = new Date();
            const gameTime = new Date(game.startTime || '');

            // Check explicit final flags first
            if (game.is_final === true) return 'FINAL';
            if (status === 'final' || status === 'post') return 'FINAL';

            // Check if explicitly marked as cancelled/postponed
            if (status === 'postponed') return 'POSTPONED';
            if (status === 'cancelled' || status === 'canceled') return 'CANCELLED';

            // Check if actively in progress
            if (game.is_active === true) return 'LIVE';
            if (status === 'live' || status === 'in') return 'LIVE';

            // Smart detection: if game time is past and has scores, it's likely final
            if (gameTime < now && (game.homeScore > 0 || game.awayScore > 0)) {
                // Check if not just starting (within 5 minutes)
                const minutesSinceStart = (now - gameTime) / (1000 * 60);
                if (minutesSinceStart > 5) {
                    return 'FINAL';
                }
            }

            // If start time is in the past but no scores, check for explicit in-progress
            if (status === 'in_progress') {
                // This is likely stale data if game time is way in past
                if (gameTime < new Date(Date.now() - 24*60*60*1000)) { // More than 24 hours ago
                    return 'FINAL';
                }
                return 'LIVE';
            }

            // If game time hasn't passed, it's upcoming
            if (gameTime > now) return 'UPCOMING';

            // Default fallback
            return 'UPCOMING';
        }

        // Build game card HTML
        function buildGameCard(game, leagueKey) {
            const config = LEAGUES[leagueKey];
            const status = normalizeStatus(game);
            const homeScore = game.homeScore ?? 0;
            const awayScore = game.awayScore ?? 0;
            const isLive = status === 'LIVE';
            const isFinal = status === 'FINAL';
            const isUpcoming = status === 'UPCOMING';

            const homeWinner = isFinal && homeScore > awayScore;
            const awayWinner = isFinal && awayScore > homeScore;

            // Get game info
            const homeTeam = game.homeTeam || {};
            const awayTeam = game.awayTeam || {};
            const venue = game.venue || homeTeam.venue || '';

            // Get odds for upcoming games
            const odds = isUpcoming ? getGameOdds(game.id || '') : null;

            let statusText = '';
            if (isLive) {
                const quarter = game.quarter || game.period || '';
                const clock = game.clock || '';
                statusText = `LIVE${quarter ? ` - Q${quarter}` : ''}${clock && clock !== '0:00' ? ` ${clock}` : ''}`;
            } else if (isFinal) {
                statusText = 'FINAL';
            } else if (status === 'POSTPONED') {
                statusText = 'POSTPONED';
            } else if (status === 'CANCELLED') {
                statusText = 'CANCELLED';
            } else {
                statusText = formatTimeEST(game.startTime);
            }

            const defaultLogo = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23334155%22 width=%22100%22 height=%22100%22/></svg>';

            return `
                <div class="game-card">
                    <div class="game-status-bar">
                        <span class="status-text ${isLive ? 'live' : ''}">${statusText}</span>
                        <span class="league-tag">${config.icon} ${leagueKey}</span>
                    </div>

                    <div class="teams-row">
                        <div class="team">
                            <img src="${awayTeam.logoUrl || defaultLogo}"
                                 alt="${awayTeam.name || 'Away'}"
                                 class="team-logo"
                                 onerror="this.src='${defaultLogo}'">
                            <div class="team-info">
                                <div class="team-name">${awayTeam.name || 'Away Team'}</div>
                                ${awayTeam.record ? `<div class="team-record">${awayTeam.record}</div>` : ''}
                            </div>
                            ${(isLive || isFinal) ? `<div class="team-score ${awayWinner ? 'winner' : ''}">${awayScore}</div>` : ''}
                        </div>

                        <div class="odds-column">
                            ${isUpcoming && odds ? `
                                <div class="odds-row">
                                    <label>Spread:</label>
                                    <span>${odds.spread > 0 ? '+' : ''}${odds.spread}</span>
                                </div>
                                <div class="odds-row">
                                    <label>O/U:</label>
                                    <span>${odds.total}</span>
                                </div>
                            ` : `
                                <div class="odds-row">
                                    <label>Spread:</label>
                                    <span></span>
                                </div>
                                <div class="odds-row">
                                    <label>O/U:</label>
                                    <span></span>
                                </div>
                            `}
                            <div class="odds-row">
                                <label>Venue:</label>
                                <span style="font-size: 0.8em;">${venue ? venue.substring(0, 18) : ''}</span>
                            </div>
                        </div>

                        <div class="team">
                            <img src="${homeTeam.logoUrl || defaultLogo}"
                                 alt="${homeTeam.name || 'Home'}"
                                 class="team-logo"
                                 onerror="this.src='${defaultLogo}'">
                            <div class="team-info">
                                <div class="team-name">${homeTeam.name || 'Home Team'}</div>
                                ${homeTeam.record ? `<div class="team-record">${homeTeam.record}</div>` : ''}
                            </div>
                            ${(isLive || isFinal) ? `<div class="team-score ${homeWinner ? 'winner' : ''}">${homeScore}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Load favorite teams from preferences and apply to filter
        function applyFavoriteTeamsToFilter() {
            const prefs = preferences.getAll();
            const favoriteTeams = prefs.favoriteTeams || [];

            if (favoriteTeams.length > 0) {
                selectedTeams.clear();
                favoriteTeams.forEach(team => {
                    selectedTeams.add(team);
                });

                // Update checkboxes to match selected teams
                const checkboxes = document.querySelectorAll('#team-checkboxes input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = selectedTeams.has(cb.value);
                });

                updateFilterButtonText();
            }
        }

        // Build team filter checkboxes based on current games
        function buildTeamFilter(games) {
            const teamsMap = new Map();

            games.forEach(game => {
                if (game.homeTeam) {
                    teamsMap.set(game.homeTeam.shortName || game.homeTeam.name, game.homeTeam.name);
                }
                if (game.awayTeam) {
                    teamsMap.set(game.awayTeam.shortName || game.awayTeam.name, game.awayTeam.name);
                }
            });

            const sortedTeams = Array.from(teamsMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));

            const container = document.getElementById('team-checkboxes');
            if (!container) return;

            if (sortedTeams.length === 0) {
                container.innerHTML = '<div style="padding: 12px; color: var(--secondary);">No teams available</div>';
                return;
            }

            container.innerHTML = `
                <div class="team-group">
                    <div class="group-label">${currentLeague} Teams</div>
                    ${sortedTeams.map(([shortName, fullName]) => `
                        <div class="team-option">
                            <input type="checkbox" id="team-${shortName}" value="${shortName}"
                                   ${selectedTeams.size === 0 || selectedTeams.has(shortName) ? 'checked' : ''}>
                            <label for="team-${shortName}">${fullName}</label>
                        </div>
                    `).join('')}
                </div>
            `;

            // Add event listeners to checkboxes
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateSelectedTeams();
                    renderGames();
                });
            });

            // Apply favorite teams to filter
            applyFavoriteTeamsToFilter();
        }

        // Update selected teams from checkboxes
        function updateSelectedTeams() {
            const checkboxes = document.querySelectorAll('#team-checkboxes input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const noneChecked = Array.from(checkboxes).every(cb => !cb.checked);

            if (allChecked || noneChecked) {
                selectedTeams.clear(); // Show all
            } else {
                selectedTeams.clear();
                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedTeams.add(cb.value);
                    }
                });
            }

            updateFilterButtonText();
        }

        // Update filter button text
        function updateFilterButtonText() {
            const btn = document.getElementById('filter-btn-text');
            if (!btn) return;

            if (selectedTeams.size === 0) {
                btn.textContent = 'All Teams';
            } else if (selectedTeams.size === 1) {
                btn.textContent = Array.from(selectedTeams)[0];
            } else {
                btn.innerHTML = `${selectedTeams.size} Teams <span class="selected-teams-count">${selectedTeams.size}</span>`;
            }
        }

        // Setup team filter dropdown
        function setupTeamFilter() {
            const btn = document.getElementById('team-filter-btn');
            const menu = document.getElementById('team-filter-menu');
            const selectAll = document.getElementById('select-all-teams');
            const clearAll = document.getElementById('clear-all-teams');

            if (!btn || !menu) return;

            // Toggle dropdown
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                btn.classList.toggle('open');
                menu.classList.toggle('open');
            });

            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.team-filter-dropdown')) {
                    btn.classList.remove('open');
                    menu.classList.remove('open');
                }
            });

            // Select all
            if (selectAll) {
                selectAll.addEventListener('click', () => {
                    document.querySelectorAll('#team-checkboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                    });
                    selectedTeams.clear();
                    updateFilterButtonText();
                    renderGames();
                });
            }

            // Clear all
            if (clearAll) {
                clearAll.addEventListener('click', () => {
                    document.querySelectorAll('#team-checkboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                    selectedTeams.clear();
                    updateFilterButtonText();
                    renderGames();
                });
            }
        }

        // Advanced filtering state and filters
        let activeFilters = {
            gameStatus: [],
            dateFrom: null,
            dateTo: null,
            teamSearch: ''
        };

        // Initialize advanced filters
        function setupAdvancedFilters() {
            // Toggle filters panel
            const toggle = document.getElementById('filters-toggle');
            const content = document.getElementById('filters-content');

            toggle.addEventListener('click', () => {
                const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                toggle.setAttribute('aria-expanded', !isExpanded);
                content.setAttribute('aria-hidden', isExpanded);
            });

            // Game status filters
            document.querySelectorAll('input[name="game-status"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (!activeFilters.gameStatus.includes(e.target.value)) {
                            activeFilters.gameStatus.push(e.target.value);
                        }
                    } else {
                        activeFilters.gameStatus = activeFilters.gameStatus.filter(s => s !== e.target.value);
                    }
                    renderGames();
                });
            });

            // Date range filters
            document.getElementById('filter-date-from').addEventListener('change', (e) => {
                activeFilters.dateFrom = e.target.value ? new Date(e.target.value) : null;
                renderGames();
            });

            document.getElementById('filter-date-to').addEventListener('change', (e) => {
                activeFilters.dateTo = e.target.value ? new Date(e.target.value) : null;
                renderGames();
            });

            // Team search
            document.getElementById('team-search').addEventListener('input', (e) => {
                activeFilters.teamSearch = e.target.value.toLowerCase();
                filterTeamList();
            });

            // Save filter preset
            document.getElementById('save-filter-btn').addEventListener('click', saveFilterPreset);

            // Clear all filters
            document.getElementById('clear-filters-btn').addEventListener('click', clearAllFilters);

            // Load saved presets
            loadFilterPresets();
        }

        // Filter team list based on search
        function filterTeamList() {
            const search = activeFilters.teamSearch;
            const checkboxes = document.querySelectorAll('#team-checkboxes input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                const label = checkbox.nextElementSibling.textContent.toLowerCase();
                const container = checkbox.closest('.team-option');
                if (label.includes(search)) {
                    container.style.display = '';
                } else {
                    container.style.display = 'none';
                }
            });
        }

        // Apply all filters to games
        function applyAdvancedFilters(games) {
            let filtered = [...games];

            // Filter by game status
            if (activeFilters.gameStatus.length > 0) {
                filtered = filtered.filter(game => {
                    const status = normalizeStatus(game);
                    return activeFilters.gameStatus.includes(status);
                });
            }

            // Filter by date range
            if (activeFilters.dateFrom || activeFilters.dateTo) {
                filtered = filtered.filter(game => {
                    if (!game.startTime) return false;
                    const gameDate = new Date(game.startTime);

                    if (activeFilters.dateFrom && gameDate < activeFilters.dateFrom) {
                        return false;
                    }
                    if (activeFilters.dateTo) {
                        const dateToPlusOne = new Date(activeFilters.dateTo);
                        dateToPlusOne.setDate(dateToPlusOne.getDate() + 1);
                        if (gameDate >= dateToPlusOne) {
                            return false;
                        }
                    }
                    return true;
                });
            }

            return filtered;
        }

        // Save filter preset
        function saveFilterPreset() {
            const presetName = prompt('Enter a name for this filter preset (e.g., "My Favorites")');
            if (!presetName) return;

            const preset = {
                name: presetName,
                teams: Array.from(selectedTeams),
                gameStatus: [...activeFilters.gameStatus],
                dateFrom: activeFilters.dateFrom ? activeFilters.dateFrom.toISOString().split('T')[0] : null,
                dateTo: activeFilters.dateTo ? activeFilters.dateTo.toISOString().split('T')[0] : null,
                league: currentLeague,
                timestamp: Date.now()
            };

            const presets = JSON.parse(localStorage.getItem('filter_presets') || '[]');
            presets.push(preset);
            localStorage.setItem('filter_presets', JSON.stringify(presets));

            loadFilterPresets();
            showToast(`Filter preset "${presetName}" saved!`, 'success');
        }

        // Load and display filter presets
        function loadFilterPresets() {
            const presets = JSON.parse(localStorage.getItem('filter_presets') || '[]');
            const presetsGroup = document.getElementById('saved-presets-group');
            const presetsList = document.getElementById('presets-list');

            if (presets.length === 0) {
                presetsGroup.style.display = 'none';
                return;
            }

            presetsGroup.style.display = 'block';
            presetsList.innerHTML = presets.map((preset, idx) => `
                <div class="preset-item">
                    <span onclick="loadFilterPreset(${idx})" style="flex: 1; cursor: pointer;">
                        ${preset.name}
                    </span>
                    <button class="preset-delete" onclick="deleteFilterPreset(${idx})"></button>
                </div>
            `).join('');
        }

        // Load a saved filter preset
        function loadFilterPreset(index) {
            const presets = JSON.parse(localStorage.getItem('filter_presets') || '[]');
            const preset = presets[index];
            if (!preset) return;

            // Set league
            currentLeague = preset.league;
            document.querySelectorAll('.league-tabs button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.league === currentLeague);
            });

            // Set teams
            selectedTeams.clear();
            preset.teams.forEach(team => selectedTeams.add(team));

            // Set game status
            activeFilters.gameStatus = preset.gameStatus;
            document.querySelectorAll('input[name="game-status"]').forEach(cb => {
                cb.checked = activeFilters.gameStatus.includes(cb.value);
            });

            // Set date range
            if (preset.dateFrom) {
                document.getElementById('filter-date-from').value = preset.dateFrom;
                activeFilters.dateFrom = new Date(preset.dateFrom);
            }
            if (preset.dateTo) {
                document.getElementById('filter-date-to').value = preset.dateTo;
                activeFilters.dateTo = new Date(preset.dateTo);
            }

            updateFilterButtonText();
            renderGames();
            showToast(`Loaded preset: "${preset.name}"`, 'info');
        }

        // Delete a filter preset
        function deleteFilterPreset(index) {
            if (!confirm('Delete this filter preset?')) return;

            const presets = JSON.parse(localStorage.getItem('filter_presets') || '[]');
            presets.splice(index, 1);
            localStorage.setItem('filter_presets', JSON.stringify(presets));

            loadFilterPresets();
            showToast('Filter preset deleted', 'info');
        }

        // Clear all filters
        function clearAllFilters() {
            selectedTeams.clear();
            activeFilters = {
                gameStatus: [],
                dateFrom: null,
                dateTo: null,
                teamSearch: ''
            };

            // Reset UI
            document.getElementById('team-search').value = '';
            document.querySelectorAll('input[name="game-status"]').forEach(cb => cb.checked = false);
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.querySelectorAll('#team-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = true);

            updateFilterButtonText();
            filterTeamList();
            renderGames();
            showToast('All filters cleared', 'info');
        }

        // Render all games in unified card format grouped by week and time
        async function renderGames() {
            const container = document.getElementById('games-grid');
            const config = LEAGUES[currentLeague];

            container.innerHTML = `
                <div class="loading-state" style="grid-column: 1 / -1;">
                    <div class="spinner"></div>
                    <p>Loading ${currentLeague} games...</p>
                </div>
            `;

            try {
                // Load video URLs from unified data
                await loadVideoUrls();

                const games = await fetchGames(currentLeague);
                allGames = enrichGamesWithVideoUrls(games);

                // Check for game changes and generate notifications
                notificationManager.checkGameChanges(games);

                // Generate week selector after loading games
                generateWeekSelector();

                // Build team filter with all available teams
                buildTeamFilter(games);

                // Filter by current week (NFL only - other sports show all games)
                let weekGames = games;
                if (currentLeague === 'NFL' && currentWeek !== null) {
                    weekGames = games.filter(game => game.week === currentWeek);
                }

                // Filter by selected teams if any are selected
                let filteredGames = [...weekGames];
                if (selectedTeams.size > 0) {
                    filteredGames = filteredGames.filter(game => {
                        const homeShort = game.homeTeam?.shortName || game.homeTeam?.name || '';
                        const awayShort = game.awayTeam?.shortName || game.awayTeam?.name || '';
                        return selectedTeams.has(homeShort) || selectedTeams.has(awayShort);
                    });
                }

                // Apply advanced filters (game status, date range)
                filteredGames = applyAdvancedFilters(filteredGames);

                if (filteredGames.length === 0) {
                    container.innerHTML = `
                        <div class="empty-msg" style="grid-column: 1 / -1;">
                            <h3>No ${currentLeague} games ${currentLeague === 'NFL' && currentWeek ? `in ${getWeekLabel(currentWeek)}` : 'scheduled'}</h3>
                            <p>Check back on active game days for real-time franchise scores.</p>
                        </div>
                    `;
                    return;
                }

                // Group games by kickoff time
                const gamesByTime = {};
                filteredGames.forEach(game => {
                    if (!game.startTime) return;

                    const gameDate = new Date(game.startTime);
                    const timeKey = gameDate.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true,
                        timeZone: 'America/New_York'
                    });

                    if (!gamesByTime[timeKey]) {
                        gamesByTime[timeKey] = [];
                    }
                    gamesByTime[timeKey].push(game);
                });

                // Sort times and games within each time slot
                const sortedTimes = Object.keys(gamesByTime).sort((a, b) => {
                    const timeA = new Date(`2000-01-01 ${a}`).getTime();
                    const timeB = new Date(`2000-01-01 ${b}`).getTime();
                    return timeA - timeB;
                });

                // Build HTML with time groups and games
                let html = '';

                // Build all card promises for all games
                const cardPromises = [];
                const cardMappings = []; // Track which card belongs to which time slot

                sortedTimes.forEach(timeSlot => {
                    const gamesAtTime = gamesByTime[timeSlot];

                    // Sort games: Final first (reverse chronological), then Live, then Upcoming
                    gamesAtTime.sort((a, b) => {
                        const statusA = normalizeStatus(a);
                        const statusB = normalizeStatus(b);

                        // Order: FINAL, LIVE, UPCOMING, CANCELLED, POSTPONED
                        const statusOrder = { 'FINAL': 0, 'LIVE': 1, 'UPCOMING': 2, 'CANCELLED': 3, 'POSTPONED': 4 };
                        const orderA = statusOrder[statusA] || 5;
                        const orderB = statusOrder[statusB] || 5;

                        if (orderA !== orderB) return orderA - orderB;

                        // Within same status, sort by start time (finals newest first)
                        const timeA = new Date(a.startTime || 0).getTime();
                        const timeB = new Date(b.startTime || 0).getTime();
                        return statusA === 'FINAL' ? timeB - timeA : timeA - timeB;
                    });

                    // Collect promises and track mapping
                    gamesAtTime.forEach(game => {
                        cardPromises.push(buildUnifiedCard(game, currentLeague));
                        cardMappings.push(timeSlot);
                    });
                });

                // Await all card builds
                const builtCards = await Promise.all(cardPromises);

                // Build final HTML with time headers and cards
                let currentTimeSlot = null;
                builtCards.forEach((cardHTML, idx) => {
                    const timeSlot = cardMappings[idx];

                    // Add time header if new time slot
                    if (timeSlot !== currentTimeSlot) {
                        html += `<div style="grid-column: 1 / -1; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-top: 16px;">
                            <div style="font-size: 1.1em; font-weight: 600; color: var(--text);">Kickoff: ${timeSlot}</div>
                        </div>`;
                        currentTimeSlot = timeSlot;
                    }

                    html += cardHTML;
                });

                container.innerHTML = html;

                // Update sports ticker with latest games
                updateSportsTicker();

            } catch (error) {
                console.error('Error rendering games:', error);
                container.innerHTML = `
                    <div class="empty-msg" style="grid-column: 1 / -1;">
                        <h3>Unable to load games</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
            }
        }

        // Fetch real weather from NOAA API
        async function getWeatherFromNOAA(venueName, gameDate) {
            try {
                // Check cache first
                const cacheKey = `${venueName}_${gameDate.toDateString()}`;
                if (weatherCache[cacheKey]) {
                    return weatherCache[cacheKey];
                }

                // Get stadium coordinates
                const stadium = NFL_STADIUMS[venueName];
                if (!stadium) return null;

                // Fetch points endpoint from NOAA (no API key required)
                const pointsResponse = await fetch(
                    `https://api.weather.gov/points/${stadium.lat.toFixed(4)},${stadium.lon.toFixed(4)}`,
                    { timeout: 5000 }
                );

                if (!pointsResponse.ok) return null;
                const pointsData = await pointsResponse.json();
                const forecastUrl = pointsData.properties?.forecast;

                if (!forecastUrl) return null;

                // Fetch forecast
                const forecastResponse = await fetch(forecastUrl, { timeout: 5000 });
                if (!forecastResponse.ok) return null;
                const forecastData = await forecastResponse.json();

                // Find the period closest to game time
                const periods = forecastData.properties?.periods || [];
                let closestPeriod = null;
                let minDiff = Infinity;

                periods.forEach(period => {
                    const periodTime = new Date(period.startTime).getTime();
                    const diff = Math.abs(periodTime - gameDate.getTime());
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestPeriod = period;
                    }
                });

                if (!closestPeriod) return null;

                // Parse weather data
                const weather = {
                    temp: closestPeriod.temperature || 70,
                    condition: closestPeriod.shortForecast || 'Unknown',
                    wind: parseInt(closestPeriod.windSpeed?.match(/\d+/)?.[0] || '10'),
                    precip: closestPeriod.probabilityOfPrecipitation?.value || 0
                };

                // Cache the result
                weatherCache[cacheKey] = weather;
                return weather;
            } catch (error) {
                console.log(`Real weather fetch failed for ${venueName}, falling back to mock`);
                return null;
            }
        }

        // Get weather data - tries real API first, falls back to mock
        async function getWeather(venueName, gameDate) {
            // Try real weather API first
            const realWeather = await getWeatherFromNOAA(venueName, gameDate);
            if (realWeather) {
                return realWeather;
            }
            // Fall back to mock weather
            return generateMockWeather(gameDate);
        }

        // Generate mock weather data based on game time
        function generateMockWeather(gameDate) {
            const month = gameDate.getMonth();
            let temp, condition, wind, precip;

            // Simulate seasonal weather patterns
            if (month >= 11 || month <= 2) { // Winter
                temp = 32 + Math.random() * 25;
                condition = Math.random() > 0.7 ? 'Snow' : (Math.random() > 0.4 ? 'Clear' : 'Cloudy');
                wind = 8 + Math.random() * 15;
                precip = Math.random() > 0.7 ? 30 : 5;
            } else if (month >= 3 && month <= 5) { // Spring
                temp = 50 + Math.random() * 20;
                condition = Math.random() > 0.6 ? 'Rain' : (Math.random() > 0.3 ? 'Cloudy' : 'Clear');
                wind = 6 + Math.random() * 10;
                precip = Math.random() > 0.6 ? 40 : 10;
            } else if (month >= 6 && month <= 8) { // Summer
                temp = 75 + Math.random() * 15;
                condition = Math.random() > 0.8 ? 'Clear' : (Math.random() > 0.5 ? 'Partly Cloudy' : 'Cloudy');
                wind = 3 + Math.random() * 8;
                precip = Math.random() > 0.9 ? 20 : 2;
            } else { // Fall
                temp = 55 + Math.random() * 20;
                condition = Math.random() > 0.6 ? 'Clear' : (Math.random() > 0.3 ? 'Cloudy' : 'Rain');
                wind = 7 + Math.random() * 12;
                precip = Math.random() > 0.7 ? 25 : 5;
            }

            return {
                temp: Math.round(temp),
                condition: condition,
                wind: Math.round(wind),
                precip: Math.round(precip)
            };
        }

        // Prediction Engine - AI-like win probability calculator with weighted factors
        class PredictionEngine {
            constructor() {
                this.weights = {
                    odds: 0.45,        // Betting odds (professional consensus)
                    record: 0.25,      // Team win-loss record
                    players: 0.20,     // Player injuries/availability
                    weather: 0.10      // Game conditions
                };

                // Position-based injury impact multipliers
                this.injuryImpactByPosition = {
                    'QB': 0.08,      // Quarterback: 8% team strength
                    'RB': 0.05,      // Running back: 5%
                    'WR': 0.04,      // Wide receiver: 4%
                    'TE': 0.03,      // Tight end: 3%
                    'OL': 0.06,      // Offensive line: 6%
                    'DL': 0.05,      // Defensive line: 5%
                    'LB': 0.04,      // Linebacker: 4%
                    'DB': 0.03,      // Defensive back: 3%
                    'PG': 0.06,      // Basketball point guard: 6%
                    'SG': 0.04,      // Shooting guard: 4%
                    'SF': 0.04,      // Small forward: 4%
                    'PF': 0.05,      // Power forward: 5%
                    'C': 0.07,       // Center: 7%
                    'P': 0.08,       // Pitcher: 8%
                    'C': 0.06,       // Catcher: 6%
                    'F': 0.05,       // Forward: 5%
                    'D': 0.04        // Defenseman/Defender: 4%
                };

                // Status-based injury severity multipliers
                this.statusMultiplier = {
                    'Out': 1.0,
                    'Doubtful': 0.8,
                    'Questionable': 0.5,
                    'Probable': 0.2
                };
            }

            /**
             * Convert American moneyline odds to implied probability
             * @param {number} moneyline - Moneyline odds (e.g., -165 or +145)
             * @returns {number} - Probability 0.0-1.0
             */
            getMoneylineProb(moneyline) {
                if (!moneyline || moneyline === 0) return 0.5;

                const ml = parseInt(moneyline);
                if (ml < 0) {
                    // Negative odds: -165 means 165/(165+100) = 0.6226
                    return Math.abs(ml) / (Math.abs(ml) + 100);
                } else {
                    // Positive odds: +145 means 100/(145+100) = 0.4082
                    return 100 / (ml + 100);
                }
            }

            /**
             * Extract win percentage from record string
             * @param {string} record - Record string like "12-3" or "8-5-0"
             * @returns {number} - Win percentage 0.0-1.0
             */
            getWinPercentage(record) {
                if (!record) return 0.5;

                const match = record.match(/(\d+)-(\d+)/);
                if (!match) return 0.5;

                const wins = parseInt(match[1]);
                const losses = parseInt(match[2]);
                const total = wins + losses;

                return total > 0 ? wins / total : 0.5;
            }

            /**
             * Calculate injury impact factor for team
             * @param {Object} team - Team object with injuries array
             * @returns {number} - Impact factor 0.75-1.0 (max 25% reduction)
             */
            getInjuryFactor(team) {
                if (!team || !team.injuries || team.injuries.length === 0) {
                    return 1.0;
                }

                let totalImpact = 0;

                for (const injury of team.injuries) {
                    const position = injury.position || 'D';
                    const status = injury.status || 'Out';

                    // Get base impact for position
                    let positionImpact = this.injuryImpactByPosition[position] || 0.04;

                    // Multiply by status severity
                    const statusMult = this.statusMultiplier[status] || 1.0;
                    const injuryImpact = positionImpact * statusMult;

                    totalImpact += injuryImpact;
                }

                // Cap maximum impact at 0.25 (75% of team strength minimum)
                const cappedImpact = Math.min(totalImpact, 0.25);
                return 1.0 - cappedImpact;
            }

            /**
             * Calculate weather impact on game probability
             * @param {Object} weather - Weather object {temp, condition, wind}
             * @param {string} venueType - 'indoor' or 'outdoor'
             * @returns {number} - Weather factor 0.85-1.15
             */
            getWeatherFactor(weather, venueType = 'outdoor') {
                if (!weather || venueType === 'indoor') {
                    return 1.0;
                }

                let factor = 1.0;

                // Wind impact (stronger wind favors passing teams less)
                if (weather.wind && weather.wind > 15) {
                    factor *= 0.98; // Slight reduction for high wind
                }

                // Temperature impact (extreme cold or heat)
                if (weather.temp) {
                    if (weather.temp < 20) {
                        factor *= 0.99; // Cold affects performance slightly
                    } else if (weather.temp > 90) {
                        factor *= 0.99; // Heat affects performance
                    }
                }

                // Precipitation impact (rain/snow favors rushing teams)
                if (weather.condition && (weather.condition.includes('Rain') || weather.condition.includes('Snow'))) {
                    factor *= 0.98;
                }

                return Math.max(0.85, Math.min(1.15, factor));
            }

            /**
             * Calculate win probability for a team
             * @param {Object} team - Team object
             * @param {Object} opponent - Opponent team object
             * @param {Object} odds - Odds object {moneyline, spread}
             * @param {Object} weather - Weather object
             * @returns {number} - Win probability 0.0-1.0
             */
            calculateWinProbability(team, opponent, odds, weather = {}) {
                // Get odds-based probability (most important)
                const oddsProb = this.getMoneylineProb(odds.moneyline);

                // Get record-based probability
                const recordProb = this.getWinPercentage(team.record);

                // Get injury factor
                const injuryFactor = this.getInjuryFactor(team);

                // Get weather factor
                const weatherFactor = this.getWeatherFactor(weather, team.venueType);

                // Weighted combination
                let prob = (
                    oddsProb * this.weights.odds +
                    recordProb * this.weights.record +
                    injuryFactor * this.weights.players +
                    weatherFactor * this.weights.weather
                );

                // Normalize
                const totalWeight = this.weights.odds + this.weights.record + this.weights.players + this.weights.weather;
                prob = prob / totalWeight;

                return Math.max(0, Math.min(1, prob));
            }

            /**
             * Calculate spread coverage probability
             * @param {number} teamWinProb - Team win probability
             * @param {number} spread - Spread value (positive favors away, negative favors home)
             * @returns {number} - Spread coverage probability
             */
            calculateSpreadCoverage(teamWinProb, spread) {
                // If spread is 0, use direct win probability
                if (spread === 0) return teamWinProb;

                // Adjust probability based on spread
                // More confident wins = better spread coverage
                // Tighter games = closer to 50%
                const confidenceLevel = Math.abs(teamWinProb - 0.5) * 2; // 0-1 scale

                // If team is favored and confident, higher spread coverage
                // If team is underdog, lower spread coverage expectation
                const adjustment = Math.sign(spread) * (confidenceLevel * 0.1);

                let spreadCoverage = teamWinProb + adjustment;
                return Math.max(0.05, Math.min(0.95, spreadCoverage));
            }

            /**
             * Get full prediction for a matchup
             * @param {Object} homeTeam - Home team
             * @param {Object} awayTeam - Away team
             * @param {Object} odds - Odds object
             * @param {Object} weather - Weather object
             * @returns {Object} - Complete prediction
             */
            getPrediction(homeTeam, awayTeam, odds = {}, weather = {}) {
                const homeOdds = odds.homeMoneyline || odds.moneyline;
                const awayOdds = odds.awayMoneyline || (odds.moneyline ? -Math.abs(odds.moneyline) : 0);
                const spread = odds.spread || 0;

                // Calculate win probabilities
                const homeWinProb = this.calculateWinProbability(
                    homeTeam,
                    awayTeam,
                    { moneyline: homeOdds, spread: spread },
                    weather
                );

                const awayWinProb = 1.0 - homeWinProb;

                // Calculate spread coverage
                const homeSpreadProb = this.calculateSpreadCoverage(homeWinProb, -Math.abs(spread));
                const awaySpreadProb = this.calculateSpreadCoverage(awayWinProb, Math.abs(spread));

                // Determine favored team
                const favored = homeWinProb > 0.5 ? 'home' : 'away';

                // Calculate confidence (how confident are we in the prediction)
                const confidence = Math.abs(homeWinProb - 0.5) * 2; // 0-1 scale

                return {
                    homeWinProb: homeWinProb,
                    awayWinProb: awayWinProb,
                    homeSpreadProb: homeSpreadProb,
                    awaySpreadProb: awaySpreadProb,
                    favored: favored,
                    confidence: confidence,
                    spread: spread
                };
            }
        }

        // Create global prediction engine instance
        const predictionEngine = new PredictionEngine();

        // Prediction cache to avoid recalculation
        const predictionCache = new Map();
        const PREDICTION_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

        // Get cached prediction or calculate new one
        function getCachedPrediction(gameId, homeTeam, awayTeam, odds, weather) {
            const cacheKey = `${gameId}_${Date.now() / PREDICTION_CACHE_TTL | 0}`; // Key changes every 5 minutes

            if (predictionCache.has(cacheKey)) {
                return predictionCache.get(cacheKey);
            }

            const prediction = predictionEngine.getPrediction(homeTeam, awayTeam, odds, weather);
            predictionCache.set(cacheKey, prediction);

            // Cleanup old cache entries (keep only recent ones)
            if (predictionCache.size > 500) {
                const entriesToDelete = Array.from(predictionCache.entries())
                    .sort((a, b) => (b[1].calculatedAt || 0) - (a[1].calculatedAt || 0))
                    .slice(250) // Keep only the 250 most recent
                    .map(([key]) => key);
                entriesToDelete.forEach(key => predictionCache.delete(key));
            }

            return prediction;
        }

        // User Preferences Manager - Handles localStorage for user settings
        class PreferencesManager {
            constructor(storageKey = 'sports_widget_preferences') {
                this.storageKey = storageKey;
                this.defaults = {
                    favoriteTeams: [],
                    favoriteLeagues: ['NFL'],
                    preferredView: 'cards',
                    refreshInterval: 'adaptive',
                    hideCompletedGames: false,
                    theme: 'dark',
                    timeZone: 'America/New_York',
                    lastViewed: { league: 'NFL', week: null },
                    notificationsEnabled: false,
                    notificationSound: true,
                    quietHoursStart: 22,
                    quietHoursEnd: 8
                };
                this.prefs = this.load();
            }

            /**
             * Load preferences from localStorage
             */
            load() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        return { ...this.defaults, ...JSON.parse(stored) };
                    }
                } catch (e) {
                    console.warn('Could not load preferences:', e);
                }
                return { ...this.defaults };
            }

            /**
             * Save preferences to localStorage
             */
            save() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.prefs));
                    return true;
                } catch (e) {
                    console.error('Could not save preferences:', e);
                    return false;
                }
            }

            /**
             * Get a preference value
             */
            get(key, defaultValue = null) {
                return this.prefs.hasOwnProperty(key) ? this.prefs[key] : defaultValue;
            }

            /**
             * Set a preference value
             */
            set(key, value) {
                this.prefs[key] = value;
                this.save();
            }

            /**
             * Toggle array preference (for favorite teams, leagues)
             */
            toggleArrayItem(key, item) {
                const arr = this.prefs[key] || [];
                const index = arr.indexOf(item);
                if (index > -1) {
                    arr.splice(index, 1);
                } else {
                    arr.push(item);
                }
                this.prefs[key] = arr;
                this.save();
                return arr;
            }

            /**
             * Check if item is in array preference
             */
            hasItem(key, item) {
                const arr = this.prefs[key] || [];
                return arr.includes(item);
            }

            /**
             * Reset all preferences to defaults
             */
            reset() {
                this.prefs = { ...this.defaults };
                localStorage.removeItem(this.storageKey);
            }

            /**
             * Get all preferences
             */
            getAll() {
                return { ...this.prefs };
            }
        }

        // Create global preferences instance
        const preferences = new PreferencesManager();

        // Notification Manager Class
        class NotificationManager {
            constructor() {
                this.notifications = JSON.parse(localStorage.getItem('game_notifications') || '[]');
                this.gameSnapshots = {}; // Track game states for change detection
                this.maxNotifications = 50; // Keep last 50 notifications
            }

            addNotification(title, message, type = 'info', data = {}) {
                const notification = {
                    id: Date.now() + Math.random(),
                    title,
                    message,
                    type, // 'info', 'goal', 'status-change', 'final'
                    icon: this.getIcon(type),
                    data,
                    timestamp: new Date(),
                    read: false
                };

                this.notifications.unshift(notification);
                if (this.notifications.length > this.maxNotifications) {
                    this.notifications.pop();
                }
                this.save();
                this.updateUI();

                // Play sound if enabled
                this.playSound(type);

                return notification;
            }

            getIcon(type) {
                const icons = {
                    'goal': '',
                    'status-change': '',
                    'final': '',
                    'live': '',
                    'upcoming': '',
                    'info': ''
                };
                return icons[type] || icons['info'];
            }

            checkGameChanges(games) {
                const prefs = preferences.getAll();
                const favoriteTeams = new Set(prefs.favoriteTeams || []);
                const notificationsEnabled = prefs.notificationsEnabled;

                if (!notificationsEnabled) return;

                games.forEach(game => {
                    const gameId = `${game.homeTeam?.shortName || game.homeTeam?.name}-${game.awayTeam?.shortName || game.awayTeam?.name}-${game.startTime}`;
                    const snapshot = this.gameSnapshots[gameId];
                    const status = normalizeStatus(game);
                    const homeShort = game.homeTeam?.shortName || game.homeTeam?.name;
                    const awayShort = game.awayTeam?.shortName || game.awayTeam?.name;
                    const isFavoriteGame = favoriteTeams.has(homeShort) || favoriteTeams.has(awayShort);

                    if (!isFavoriteGame) return; // Only notify for favorite teams

                    if (!snapshot) {
                        // First time seeing this game
                        this.gameSnapshots[gameId] = {
                            status,
                            homeScore: game.homeScore ?? 0,
                            awayScore: game.awayScore ?? 0
                        };
                        return;
                    }

                    // Check for status change
                    if (snapshot.status !== status) {
                        if (status === 'LIVE') {
                            this.addNotification(
                                `${homeShort} vs ${awayShort}`,
                                'Game started!',
                                'live',
                                { game }
                            );
                        } else if (status === 'FINAL') {
                            const homeScore = game.homeScore ?? 0;
                            const awayScore = game.awayScore ?? 0;
                            const winner = homeScore > awayScore ? homeShort : awayShort;
                            this.addNotification(
                                `${homeShort} vs ${awayShort}`,
                                `Game final: ${winner} wins ${homeScore}-${awayScore}`,
                                'final',
                                { game }
                            );
                        }
                    }

                    // Check for score changes
                    if ((game.homeScore ?? 0) !== snapshot.homeScore || (game.awayScore ?? 0) !== snapshot.awayScore) {
                        const homeScore = game.homeScore ?? 0;
                        const awayScore = game.awayScore ?? 0;
                        this.addNotification(
                            `${homeShort} vs ${awayShort}`,
                            `Score: ${homeShort} ${homeScore} - ${awayShort} ${awayScore}`,
                            'goal',
                            { game }
                        );
                    }

                    // Update snapshot
                    this.gameSnapshots[gameId] = {
                        status,
                        homeScore: game.homeScore ?? 0,
                        awayScore: game.awayScore ?? 0
                    };
                });
            }

            playSound(type) {
                const prefs = preferences.getAll();
                if (!prefs.notificationSound) return;

                if (this.isInQuietHours()) return; // Respect quiet hours

                // Create a simple beep using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    const frequency = type === 'goal' ? 800 : type === 'final' ? 600 : 400;
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.warn('Could not play sound:', e);
                }
            }

            isInQuietHours() {
                const prefs = preferences.getAll();
                const now = new Date();
                const hour = now.getHours();
                const start = prefs.quietHoursStart;
                const end = prefs.quietHoursEnd;

                if (start < end) {
                    return hour >= start && hour < end;
                } else {
                    return hour >= start || hour < end;
                }
            }

            updateUI() {
                const unreadCount = this.notifications.filter(n => !n.read).length;
                const badge = document.getElementById('notification-badge');
                const list = document.getElementById('notification-list');

                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }

                if (this.notifications.length === 0) {
                    list.innerHTML = '<div class="notification-empty">No notifications yet</div>';
                    return;
                }

                list.innerHTML = this.notifications.map(n => `
                    <div class="notification-item ${!n.read ? 'new' : ''}">
                        <div class="notification-icon">${n.icon}</div>
                        <div class="notification-content">
                            <div class="notification-title">${n.title}</div>
                            <div class="notification-message">${n.message}</div>
                            <div class="notification-time">${this.formatTime(n.timestamp)}</div>
                        </div>
                        <button class="notification-remove" onclick="removeNotification('${n.id}')"></button>
                    </div>
                `).join('');

                // Mark as read
                this.notifications.forEach(n => n.read = true);
                this.save();
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);

                if (diffMins < 1) return 'now';
                if (diffMins < 60) return `${diffMins}m ago`;
                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `${diffHours}h ago`;
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays}d ago`;
            }

            removeNotification(id) {
                this.notifications = this.notifications.filter(n => n.id !== id);
                this.save();
                this.updateUI();
            }

            clearAll() {
                this.notifications = [];
                this.save();
                this.updateUI();
            }

            save() {
                localStorage.setItem('game_notifications', JSON.stringify(this.notifications));
            }
        }

        const notificationManager = new NotificationManager();

        // Analytics Manager Class
        class AnalyticsManager {
            constructor() {
                this.gameHistory = JSON.parse(localStorage.getItem('game_history') || '[]');
                this.predictions = JSON.parse(localStorage.getItem('game_predictions') || '[]');
                this.teamStats = {};
                this.seasonStats = {};
                this.buildStats();
            }

            recordGame(game) {
                const gameId = `${game.homeTeam?.shortName || game.homeTeam?.name}-${game.awayTeam?.shortName || game.awayTeam?.name}-${game.startTime}`;

                // Check if game already recorded
                if (this.gameHistory.find(g => g.id === gameId)) {
                    return; // Game already recorded
                }

                const finalGame = {
                    id: gameId,
                    league: game.league || 'UNKNOWN',
                    date: new Date(game.startTime).toISOString().split('T')[0],
                    homeTeam: game.homeTeam?.shortName || game.homeTeam?.name,
                    awayTeam: game.awayTeam?.shortName || game.awayTeam?.name,
                    homeScore: game.homeScore ?? 0,
                    awayScore: game.awayScore ?? 0,
                    status: normalizeStatus(game),
                    recordedAt: new Date().toISOString()
                };

                if (finalGame.status === 'FINAL') {
                    this.gameHistory.unshift(finalGame);
                    if (this.gameHistory.length > 500) {
                        this.gameHistory.pop(); // Keep last 500 games
                    }
                    this.save();
                    this.buildStats();
                }
            }

            recordPrediction(game, prediction) {
                const predictionRecord = {
                    id: `${game.homeTeam?.shortName}-${game.awayTeam?.shortName}-${game.startTime}`,
                    league: game.league || 'UNKNOWN',
                    date: new Date(game.startTime).toISOString().split('T')[0],
                    homeTeam: game.homeTeam?.shortName || game.homeTeam?.name,
                    awayTeam: game.awayTeam?.shortName || game.awayTeam?.name,
                    prediction: prediction, // 'HOME', 'AWAY', 'OVER', 'UNDER'
                    homeScore: game.homeScore,
                    awayScore: game.awayScore,
                    status: normalizeStatus(game),
                    correct: null,
                    recordedAt: new Date().toISOString()
                };

                // Check if prediction already recorded
                const existing = this.predictions.find(p => p.id === predictionRecord.id);
                if (!existing) {
                    this.predictions.unshift(predictionRecord);
                    if (this.predictions.length > 500) {
                        this.predictions.pop();
                    }
                    this.save();
                }
            }

            buildStats() {
                this.teamStats = {};
                this.seasonStats = {};

                this.gameHistory.forEach(game => {
                    if (game.status !== 'FINAL') return;

                    // Initialize team stats if not exists
                    if (!this.teamStats[game.homeTeam]) {
                        this.teamStats[game.homeTeam] = {
                            team: game.homeTeam,
                            wins: 0,
                            losses: 0,
                            ties: 0,
                            pointsFor: 0,
                            pointsAgainst: 0,
                            games: []
                        };
                    }
                    if (!this.teamStats[game.awayTeam]) {
                        this.teamStats[game.awayTeam] = {
                            team: game.awayTeam,
                            wins: 0,
                            losses: 0,
                            ties: 0,
                            pointsFor: 0,
                            pointsAgainst: 0,
                            games: []
                        };
                    }

                    // Update league season stats
                    if (!this.seasonStats[game.league]) {
                        this.seasonStats[game.league] = {
                            league: game.league,
                            totalGames: 0,
                            teamRecords: {}
                        };
                    }
                    this.seasonStats[game.league].totalGames++;

                    // Record game and update stats
                    const homeStats = this.teamStats[game.homeTeam];
                    const awayStats = this.teamStats[game.awayTeam];

                    homeStats.pointsFor += game.homeScore;
                    homeStats.pointsAgainst += game.awayScore;
                    awayStats.pointsFor += game.awayScore;
                    awayStats.pointsAgainst += game.homeScore;

                    homeStats.games.push({
                        opponent: game.awayTeam,
                        pointsFor: game.homeScore,
                        pointsAgainst: game.awayScore,
                        result: game.homeScore > game.awayScore ? 'W' : game.homeScore < game.awayScore ? 'L' : 'T',
                        date: game.date
                    });
                    awayStats.games.push({
                        opponent: game.homeTeam,
                        pointsFor: game.awayScore,
                        pointsAgainst: game.homeScore,
                        result: game.awayScore > game.homeScore ? 'W' : game.awayScore < game.homeScore ? 'L' : 'T',
                        date: game.date
                    });

                    // Update wins/losses
                    if (game.homeScore > game.awayScore) {
                        homeStats.wins++;
                        awayStats.losses++;
                    } else if (game.awayScore > game.homeScore) {
                        awayStats.wins++;
                        homeStats.losses++;
                    } else {
                        homeStats.ties++;
                        awayStats.ties++;
                    }
                });
            }

            getTeamStats(team) {
                return this.teamStats[team] || null;
            }

            getLeagueStats(league) {
                return this.seasonStats[league] || null;
            }

            getAllTeamStats() {
                return Object.values(this.teamStats)
                    .sort((a, b) => {
                        const aWinPct = a.wins / (a.wins + a.losses + a.ties) || 0;
                        const bWinPct = b.wins / (b.wins + b.losses + b.ties) || 0;
                        return bWinPct - aWinPct;
                    });
            }

            getPredictionAccuracy() {
                if (this.predictions.length === 0) return { correct: 0, total: 0, accuracy: 0 };

                let correct = 0;
                let total = 0;

                this.predictions.forEach(pred => {
                    if (pred.status === 'FINAL') {
                        total++;
                        if (pred.prediction === 'HOME' && pred.homeScore > pred.awayScore) {
                            correct++;
                        } else if (pred.prediction === 'AWAY' && pred.awayScore > pred.homeScore) {
                            correct++;
                        }
                    }
                });

                return {
                    correct,
                    total,
                    accuracy: total > 0 ? Math.round((correct / total) * 100) : 0
                };
            }

            getRecentGames(count = 10) {
                return this.gameHistory.slice(0, count);
            }

            save() {
                localStorage.setItem('game_history', JSON.stringify(this.gameHistory));
                localStorage.setItem('game_predictions', JSON.stringify(this.predictions));
            }

            clearHistory() {
                this.gameHistory = [];
                this.predictions = [];
                this.teamStats = {};
                this.seasonStats = {};
                this.save();
            }
        }

        const analyticsManager = new AnalyticsManager();

        // Build unified card for both completed and upcoming games
        async function buildUnifiedCard(game, leagueKey) {
            const homeTeam = game.homeTeam || {};
            const awayTeam = game.awayTeam || {};
            const homeScore = game.homeScore ?? 0;
            const awayScore = game.awayScore ?? 0;
            const defaultLogo = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23334155%22 width=%22100%22 height=%22100%22/></svg>';

            const gameDate = new Date(game.startTime);
            const dateStr = gameDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const timeStr = gameDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            const status = normalizeStatus(game);
            const isFinal = status === 'FINAL';
            const isLive = status === 'LIVE';
            const isUpcoming = status === 'UPCOMING';

            // Get video URL for completed games
            const cachedVideoUrl = getVideoUrl(awayTeam, homeTeam);
            const videoUrl = game.video_url || cachedVideoUrl || null;
            const hasVideo = isFinal && videoUrl;

            // Check if championship/finals game
            const isChampionship = game.is_championship || game.isChampionship;

            // Get odds for this game (with real API if configured)
            const odds = await getGameOdds(game.id || '',
                awayTeam.shortName || awayTeam.name || '',
                homeTeam.shortName || homeTeam.name || '');

            // Get stadium info
            const stadium = game.venue || homeTeam.venue || 'TBD';

            // Get weather data
            const weather = await getWeather(stadium, gameDate);

            // Calculate prediction for upcoming games
            let prediction = null;
            if (isUpcoming) {
                // Prepare team data for prediction engine
                const homeTeamData = {
                    name: homeTeam.name,
                    record: game.homeTeamRecord || '0-0',
                    injuries: game.homeTeamInjuries || [],
                    venueType: 'outdoor' // Default to outdoor
                };

                const awayTeamData = {
                    name: awayTeam.name,
                    record: game.awayTeamRecord || '0-0',
                    injuries: game.awayTeamInjuries || [],
                    venueType: 'outdoor'
                };

                // Use cached prediction to improve performance
                prediction = getCachedPrediction(game.id || '', homeTeamData, awayTeamData, odds, weather);
            }

            // Build recap summary
            const recap = generateRecap(game);

            // Determine badge content
            let badgeContent = '';
            if (isFinal) {
                if (isChampionship) {
                    badgeContent = '<span class="video-badge" style="background: linear-gradient(135deg, #f59e0b, #d97706);">FINALS</span>';
                } else {
                    badgeContent = hasVideo ? '<span class="video-badge">VIDEO</span>' : '';
                }
            } else if (isLive) {
                badgeContent = '<span class="video-badge" style="background: var(--live);">LIVE</span>';
            } else {
                badgeContent = '<span class="highlight-badge">UPCOMING</span>';
            }

            // Build metadata section
            let metadataHTML = `
                <div style="font-size: 0.85em; color: var(--secondary); margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="margin-bottom: 6px;">
                        <strong>${stadium}</strong>
                    </div>
                    <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                        <span>${weather.temp}F  ${weather.condition}</span>
                        <span style="font-size: 0.8em;">Wind ${weather.wind} mph</span>
                    </div>
                </div>
            `;

            // Add odds line for upcoming games
            if (isUpcoming) {
                metadataHTML += `
                    <div style="font-size: 0.85em; color: var(--secondary); margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                        <strong>Spread:</strong> ${odds.spread > 0 ? '+' : ''}${odds.spread} | <strong>O/U:</strong> ${odds.total}
                    </div>
                `;

                // Add prediction panel for upcoming games
                if (prediction) {
                    const homeWinPercent = Math.round(prediction.homeWinProb * 100);
                    const awayWinPercent = Math.round(prediction.awayWinProb * 100);
                    const homeSpreadPercent = Math.round(prediction.homeSpreadProb * 100);
                    const awaySpreadPercent = Math.round(prediction.awaySpreadProb * 100);

                    metadataHTML += `
                        <div style="font-size: 0.85em; margin-top: 10px; padding: 10px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); border-radius: 8px; border-left: 3px solid var(--accent1);">
                            <div style="font-weight: 600; color: var(--accent1); margin-bottom: 8px; font-size: 0.9em;">PREDICTION</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <div style="color: var(--secondary); font-size: 0.75em; margin-bottom: 6px; text-transform: uppercase; font-weight: 600;">Win Probability</div>
                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.8em;">
                                            <span style="color: #6366f1; font-weight: 500;">${awayTeam.shortName || awayTeam.name}</span>
                                            <span style="color: #6366f1; font-weight: 600;">${awayWinPercent}%</span>
                                        </div>
                                        <div style="width: 100%; height: 6px; background: rgba(99, 102, 241, 0.2); border-radius: 3px; overflow: hidden;">
                                            <div style="height: 100%; width: ${awayWinPercent}%; background: linear-gradient(90deg, #6366f1, #6366f1dd); border-radius: 3px; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.8em;">
                                            <span style="color: #a855f7; font-weight: 500;">${homeTeam.shortName || homeTeam.name}</span>
                                            <span style="color: #a855f7; font-weight: 600;">${homeWinPercent}%</span>
                                        </div>
                                        <div style="width: 100%; height: 6px; background: rgba(168, 85, 247, 0.2); border-radius: 3px; overflow: hidden;">
                                            <div style="height: 100%; width: ${homeWinPercent}%; background: linear-gradient(90deg, #a855f7, #a855f7dd); border-radius: 3px; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div style="color: var(--secondary); font-size: 0.75em; margin-bottom: 6px; text-transform: uppercase; font-weight: 600;">Spread Coverage</div>
                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.8em;">
                                            <span style="color: #6366f1; font-weight: 500;">Away</span>
                                            <span style="color: #6366f1; font-weight: 600;">${awaySpreadPercent}%</span>
                                        </div>
                                        <div style="width: 100%; height: 6px; background: rgba(99, 102, 241, 0.2); border-radius: 3px; overflow: hidden;">
                                            <div style="height: 100%; width: ${awaySpreadPercent}%; background: linear-gradient(90deg, #6366f1, #6366f1dd); border-radius: 3px; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.8em;">
                                            <span style="color: #a855f7; font-weight: 500;">Home</span>
                                            <span style="color: #a855f7; font-weight: 600;">${homeSpreadPercent}%</span>
                                        </div>
                                        <div style="width: 100%; height: 6px; background: rgba(168, 85, 247, 0.2); border-radius: 3px; overflow: hidden;">
                                            <div style="height: 100%; width: ${homeSpreadPercent}%; background: linear-gradient(90deg, #a855f7, #a855f7dd); border-radius: 3px; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            const clickHandler = `onclick="openGameDrawer(event, '${encodeURIComponent(JSON.stringify({
                ...game,
                leagueKey,
                status,
                prediction,
                awayTeamPlayers: game.awayTeamPlayers || [],
                homeTeamPlayers: game.homeTeamPlayers || [],
                awayTeamInjuries: game.awayTeamInjuries || [],
                homeTeamInjuries: game.homeTeamInjuries || []
            }))')"`;

            return `
                <div class="highlight-card" ${clickHandler} style="cursor: pointer;">
                    <div class="highlight-thumbnail">
                        <div class="team-logos">
                            <img src="${awayTeam.logoUrl || defaultLogo}" alt="${awayTeam.name}" onerror="this.src='${defaultLogo}'">
                            <span class="vs-text">@</span>
                            <img src="${homeTeam.logoUrl || defaultLogo}" alt="${homeTeam.name}" onerror="this.src='${defaultLogo}'">
                        </div>
                        ${hasVideo ? `<div class="play-overlay"><div class="play-btn"></div></div>` : ''}
                        ${badgeContent}
                    </div>
                    <div class="highlight-info">
                        <div class="highlight-matchup">
                            <span class="highlight-teams">${awayTeam.shortName || awayTeam.name} @ ${homeTeam.shortName || homeTeam.name}</span>
                            ${(isFinal || isLive) ? `<span class="highlight-score">${awayScore} - ${homeScore}</span>` : ''}
                        </div>
                        <div class="highlight-meta">
                            <span>${dateStr}</span>
                            <span class="highlight-badge">${isFinal ? (isChampionship ? 'CHAMPIONSHIP' : 'FINAL') : (isLive ? 'LIVE' : timeStr)}</span>
                        </div>
                        ${metadataHTML}
                        ${isFinal ? `<p class="highlight-recap">${recap}</p>` : ''}
                    </div>
                </div>
            `;
        }

        // Initialize current league from user preferences
        function initializeCurrentLeague() {
            const prefs = preferences.getAll();
            const favoriteLeagues = prefs.favoriteLeagues && prefs.favoriteLeagues.length > 0
                ? prefs.favoriteLeagues
                : ['NFL'];

            // Set currentLeague to first favorite league
            currentLeague = favoriteLeagues[0];

            // Mark favorite leagues in tabs
            const leagueTabs = document.querySelectorAll('.league-tabs button');
            leagueTabs.forEach(tab => {
                const league = tab.dataset.league;
                if (favoriteLeagues.includes(league)) {
                    tab.style.fontWeight = '600';
                    tab.style.opacity = '1';
                } else {
                    tab.style.opacity = '0.6';
                }
            });
        }

        // Set up league tab click handlers
        function setupLeagueTabs() {
            // Initialize current league from preferences
            initializeCurrentLeague();

            document.querySelectorAll('.league-tabs button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.league-tabs button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentLeague = btn.dataset.league;
                    currentWeek = null; // Reset week selector when changing leagues
                    selectedTeams.clear(); // Reset team filter when changing leagues
                    updateFilterButtonText();
                    gamesCache = {}; // Clear cache to reload data for new league
                    renderGames();
                });
            });

            // Set active tab to currentLeague
            const activeBtn = document.querySelector(`.league-tabs button[data-league="${currentLeague}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // Generate prediction factor breakdown visualization
        function generatePredictionBreakdown(prediction) {
            if (!prediction) return '';

            // Calculate individual factor contributions (based on weights: odds 45%, record 25%, players 20%, weather 10%)
            const factors = [
                { name: 'Betting Odds', weight: 45, color: '#f59e0b' },
                { name: 'Team Record', weight: 25, color: '#10b981' },
                { name: 'Player Health', weight: 20, color: '#8b5cf6' },
                { name: 'Weather Impact', weight: 10, color: '#3b82f6' }
            ];

            return `
                <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div style="font-size: 0.85em; color: var(--secondary); margin-bottom: 12px; text-transform: uppercase; font-weight: 600;">
                        Prediction Factors
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${factors.map(factor => `
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85em;">
                                    <span style="color: var(--secondary);">${factor.name}</span>
                                    <span style="color: ${factor.color}; font-weight: 600;">${factor.weight}%</span>
                                </div>
                                <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: ${factor.weight}%; background: linear-gradient(90deg, ${factor.color}, ${factor.color}aa); border-radius: 3px;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Open game details drawer
        async function openGameDrawer(event, gameData) {
            event.stopPropagation();
            try {
                const game = typeof gameData === 'string' ? JSON.parse(decodeURIComponent(gameData)) : gameData;
                const drawer = document.getElementById('game-details-drawer');
                const overlay = document.getElementById('drawer-overlay');
                const content = document.getElementById('drawer-content');
                const matchup = document.getElementById('drawer-matchup');

                const homeTeam = game.homeTeam || {};
                const awayTeam = game.awayTeam || {};
                const weather = await getWeather(game.venue, new Date(game.startTime));
                const odds = await getGameOdds(game.id || '',
                    awayTeam.shortName || awayTeam.name || '',
                    homeTeam.shortName || homeTeam.name || '');
                const status = normalizeStatus(game);
                const isFinal = status === 'FINAL';
                const isLive = status === 'LIVE';
                const isUpcoming = status === 'UPCOMING';

                // Set matchup title
                matchup.textContent = `${awayTeam.shortName || awayTeam.name} @ ${homeTeam.shortName || homeTeam.name}`;

                let html = '';

                if (isLive) {
                    // LIVE game content
                    const quarter = game.quarter || game.period || 'Q1';
                    const clock = game.clock || '0:00';
                    html = `
                        <div class="detail-section">
                            <h3><span class="live-indicator"></span>Live Game Status</h3>
                            <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--live);">
                                <div style="font-size: 1.2em; font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    ${awayTeam.shortName || awayTeam.name}: ${game.awayScore ?? 0}
                                </div>
                                <div style="font-size: 1.2em; font-weight: 600; color: var(--text); margin-bottom: 12px;">
                                    ${homeTeam.shortName || homeTeam.name}: ${game.homeScore ?? 0}
                                </div>
                                <div style="font-size: 0.95em; color: var(--secondary);">
                                    ${quarter} - ${clock}
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Game Info</h3>
                            <div class="weather-section">
                                <div class="weather-item">
                                    <span>Temperature:</span>
                                    <span>${weather.temp}F</span>
                                </div>
                                <div class="weather-item">
                                    <span>Condition:</span>
                                    <span>${weather.condition}</span>
                                </div>
                                <div class="weather-item">
                                    <span>Wind:</span>
                                    <span>${weather.wind} mph</span>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Venue</h3>
                            <div style="font-size: 0.9em; color: var(--text);">${game.venue || 'TBD'}</div>
                        </div>

                        ${game.network ? `
                        <div class="detail-section">
                            <h3>Broadcast</h3>
                            <div style="font-size: 0.9em; color: var(--text);">${game.network}</div>
                        </div>
                        ` : ''}

                        <p style="font-size: 0.85em; color: var(--secondary); text-align: center; margin-top: 20px;">
                            Updates every 15 seconds
                        </p>
                    `;
                } else if (isUpcoming) {
                    // UPCOMING game content
                    const gameDate = new Date(game.startTime);
                    const dateStr = gameDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    const timeStr = gameDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

                    html = `
                        <div class="detail-section">
                            <h3>Kickoff Information</h3>
                            <div style="background: rgba(99, 102, 241, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--accent1);">
                                <div style="margin-bottom: 8px;">
                                    <div style="font-size: 0.85em; color: var(--secondary); margin-bottom: 2px;">DATE</div>
                                    <div style="font-weight: 600; color: var(--text);">${dateStr}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85em; color: var(--secondary); margin-bottom: 2px;">TIME</div>
                                    <div style="font-weight: 600; color: var(--text);">${timeStr} EST</div>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Betting Odds</h3>
                            <div class="odds-breakdown">
                                <div class="odds-item">
                                    <span class="odds-label">Spread:</span>
                                    <span class="odds-value">${odds.spread > 0 ? '+' : ''}${odds.spread}</span>
                                </div>
                                <div class="odds-item">
                                    <span class="odds-label">Over/Under:</span>
                                    <span class="odds-value">${odds.total}</span>
                                </div>
                                <div class="odds-item">
                                    <span class="odds-label">Favorite:</span>
                                    <span class="odds-value">${odds.spread > 0 ? awayTeam.shortName || awayTeam.name : homeTeam.shortName || homeTeam.name}</span>
                                </div>
                            </div>
                        </div>

                        ${game.prediction ? `
                        <div class="detail-section">
                            <h3>Game Prediction</h3>
                            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); padding: 16px; border-radius: 8px; border-left: 3px solid var(--accent1);">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.85em; color: var(--secondary); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Win Probability</div>
                                        <div style="background: rgba(99, 102, 241, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                            <div style="color: #6366f1; font-size: 0.9em; margin-bottom: 4px;">${awayTeam.shortName || awayTeam.name}</div>
                                            <div style="color: #6366f1; font-weight: 700; font-size: 1.4em;">${Math.round(game.prediction.awayWinProb * 100)}%</div>
                                        </div>
                                        <div style="background: rgba(168, 85, 247, 0.2); padding: 12px; border-radius: 8px;">
                                            <div style="color: #a855f7; font-size: 0.9em; margin-bottom: 4px;">${homeTeam.shortName || homeTeam.name}</div>
                                            <div style="color: #a855f7; font-weight: 700; font-size: 1.4em;">${Math.round(game.prediction.homeWinProb * 100)}%</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.85em; color: var(--secondary); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Spread Coverage</div>
                                        <div style="background: rgba(99, 102, 241, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                            <div style="color: #6366f1; font-size: 0.9em; margin-bottom: 4px;">${awayTeam.shortName || awayTeam.name}</div>
                                            <div style="color: #6366f1; font-weight: 700; font-size: 1.4em;">${Math.round(game.prediction.awaySpreadProb * 100)}%</div>
                                        </div>
                                        <div style="background: rgba(168, 85, 247, 0.2); padding: 12px; border-radius: 8px;">
                                            <div style="color: #a855f7; font-size: 0.9em; margin-bottom: 4px;">${homeTeam.shortName || homeTeam.name}</div>
                                            <div style="color: #a855f7; font-weight: 700; font-size: 1.4em;">${Math.round(game.prediction.homeSpreadProb * 100)}%</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; text-align: center;">
                                    <div style="font-size: 0.85em; color: var(--secondary); margin-bottom: 6px;">Confidence Level</div>
                                    <div style="font-weight: 600; color: var(--text); font-size: 1.1em;">${(game.prediction.confidence * 100).toFixed(0)}%</div>
                                </div>
                                ${generatePredictionBreakdown(game.prediction)}
                            </div>
                        </div>
                        ` : ''}

                        <div class="detail-section">
                            <h3>Team Comparison</h3>
                            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 12px; align-items: center;">
                                <!-- Away Team Column -->
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: #6366f1; margin-bottom: 8px;">${awayTeam.shortName || awayTeam.name}</div>
                                    <div style="font-size: 0.85em; line-height: 1.6;">
                                        <div style="margin-bottom: 4px;">
                                            <span style="color: var(--secondary);">Record:</span>
                                            <span style="color: var(--text); font-weight: 500;">${awayTeam.record || 'TBD'}</span>
                                        </div>
                                        <div style="margin-bottom: 4px;">
                                            <span style="color: var(--secondary);">Rank:</span>
                                            <span style="color: var(--text); font-weight: 500;">#${awayTeam.rank || ''}</span>
                                        </div>
                                        ${awayTeam.record ? `
                                        <div>
                                            <span style="color: var(--secondary);">Win %:</span>
                                            <span style="color: var(--text); font-weight: 500;">${(() => {
                                                const match = (awayTeam.record || '').match(/(\d+)-(\d+)/);
                                                if (match) {
                                                    const wins = parseInt(match[1]);
                                                    const losses = parseInt(match[2]);
                                                    const total = wins + losses;
                                                    return total > 0 ? ((wins / total) * 100).toFixed(1) + '%' : 'N/A';
                                                }
                                                return 'N/A';
                                            })()}</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <!-- Middle Column (spacer) -->
                                <div style="width: 20px; text-align: center; color: var(--secondary); font-weight: 600;">VS</div>

                                <!-- Home Team Column -->
                                <div style="text-align: left;">
                                    <div style="font-weight: 600; color: #a855f7; margin-bottom: 8px;">${homeTeam.shortName || homeTeam.name}</div>
                                    <div style="font-size: 0.85em; line-height: 1.6;">
                                        <div style="margin-bottom: 4px;">
                                            <span style="color: var(--secondary);">Record:</span>
                                            <span style="color: var(--text); font-weight: 500;">${homeTeam.record || 'TBD'}</span>
                                        </div>
                                        <div style="margin-bottom: 4px;">
                                            <span style="color: var(--secondary);">Rank:</span>
                                            <span style="color: var(--text); font-weight: 500;">#${homeTeam.rank || ''}</span>
                                        </div>
                                        ${homeTeam.record ? `
                                        <div>
                                            <span style="color: var(--secondary);">Win %:</span>
                                            <span style="color: var(--text); font-weight: 500;">${(() => {
                                                const match = (homeTeam.record || '').match(/(\d+)-(\d+)/);
                                                if (match) {
                                                    const wins = parseInt(match[1]);
                                                    const losses = parseInt(match[2]);
                                                    const total = wins + losses;
                                                    return total > 0 ? ((wins / total) * 100).toFixed(1) + '%' : 'N/A';
                                                }
                                                return 'N/A';
                                            })()}</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${(game.homeTeamInjuries && game.homeTeamInjuries.length > 0) || (game.awayTeamInjuries && game.awayTeamInjuries.length > 0) ? `
                        <div class="detail-section">
                            <h3>Injury Report</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                ${(game.awayTeamInjuries && game.awayTeamInjuries.length > 0) ? `
                                <div>
                                    <div style="font-weight: 600; color: #6366f1; margin-bottom: 8px; font-size: 0.9em;">${awayTeam.shortName || awayTeam.name} Injuries</div>
                                    <div style="font-size: 0.85em;">
                                        ${game.awayTeamInjuries.map(injury => `
                                            <div style="padding: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 6px; margin-bottom: 6px;">
                                                <div style="font-weight: 500; color: var(--text); margin-bottom: 2px;">${injury.playerName}</div>
                                                <div style="color: var(--secondary); font-size: 0.8em;">
                                                    ${injury.position}  <span style="padding: 2px 6px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; color: #ef4444; font-weight: 600;">${injury.status}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : '<div style="color: var(--secondary); font-size: 0.9em;">No injuries reported</div>'}

                                ${(game.homeTeamInjuries && game.homeTeamInjuries.length > 0) ? `
                                <div>
                                    <div style="font-weight: 600; color: #a855f7; margin-bottom: 8px; font-size: 0.9em;">${homeTeam.shortName || homeTeam.name} Injuries</div>
                                    <div style="font-size: 0.85em;">
                                        ${game.homeTeamInjuries.map(injury => `
                                            <div style="padding: 8px; background: rgba(168, 85, 247, 0.1); border-radius: 6px; margin-bottom: 6px;">
                                                <div style="font-weight: 500; color: var(--text); margin-bottom: 2px;">${injury.playerName}</div>
                                                <div style="color: var(--secondary); font-size: 0.8em;">
                                                    ${injury.position}  <span style="padding: 2px 6px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; color: #ef4444; font-weight: 600;">${injury.status}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : '<div style="color: var(--secondary); font-size: 0.9em;">No injuries reported</div>'}
                            </div>
                        </div>
                        ` : ''}

                        ${game.awayTeamPlayers || game.homeTeamPlayers ? `
                        <div class="detail-section">
                            <h3>Top Performers</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                ${game.awayTeamPlayers && game.awayTeamPlayers.length > 0 ? `
                                <div>
                                    <div style="font-weight: 600; color: #6366f1; margin-bottom: 8px; font-size: 0.9em;">${awayTeam.shortName || awayTeam.name}</div>
                                    <div style="font-size: 0.8em;">
                                        ${game.awayTeamPlayers.slice(0, 5).map(player => `
                                            <div style="padding: 8px; background: rgba(99, 102, 241, 0.08); border-radius: 6px; margin-bottom: 6px;">
                                                <div style="font-weight: 500; color: var(--text); margin-bottom: 2px;">
                                                    #${player.jersey || '?'} ${player.name}
                                                </div>
                                                <div style="color: var(--secondary); font-size: 0.75em; margin-bottom: 3px;">
                                                    ${player.position || 'N/A'}
                                                </div>
                                                ${player.stats && Object.keys(player.stats).length > 0 ? `
                                                <div style="color: #6366f1; font-size: 0.75em; font-weight: 500;">
                                                    ${Object.entries(player.stats).slice(0, 2).map(([key, val]) =>
                                                        \`\${key}: \${val}\`
                                                    ).join('  ')}
                                                </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}

                                ${game.homeTeamPlayers && game.homeTeamPlayers.length > 0 ? `
                                <div>
                                    <div style="font-weight: 600; color: #a855f7; margin-bottom: 8px; font-size: 0.9em;">${homeTeam.shortName || homeTeam.name}</div>
                                    <div style="font-size: 0.8em;">
                                        ${game.homeTeamPlayers.slice(0, 5).map(player => `
                                            <div style="padding: 8px; background: rgba(168, 85, 247, 0.08); border-radius: 6px; margin-bottom: 6px;">
                                                <div style="font-weight: 500; color: var(--text); margin-bottom: 2px;">
                                                    #${player.jersey || '?'} ${player.name}
                                                </div>
                                                <div style="color: var(--secondary); font-size: 0.75em; margin-bottom: 3px;">
                                                    ${player.position || 'N/A'}
                                                </div>
                                                ${player.stats && Object.keys(player.stats).length > 0 ? `
                                                <div style="color: #a855f7; font-size: 0.75em; font-weight: 500;">
                                                    ${Object.entries(player.stats).slice(0, 2).map(([key, val]) =>
                                                        \`\${key}: \${val}\`
                                                    ).join('  ')}
                                                </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}

                        <div class="detail-section">
                            <h3>Weather Forecast</h3>
                            <div class="weather-section">
                                <div class="weather-item">
                                    <span>Temperature:</span>
                                    <span>${weather.temp}F</span>
                                </div>
                                <div class="weather-item">
                                    <span>Condition:</span>
                                    <span>${weather.condition}</span>
                                </div>
                                <div class="weather-item">
                                    <span>Wind Speed:</span>
                                    <span>${weather.wind} mph</span>
                                </div>
                                <div class="weather-item">
                                    <span>Precipitation:</span>
                                    <span>${weather.precip}%</span>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Venue</h3>
                            <div style="font-size: 0.9em; color: var(--text);">${game.venue || 'TBD'}</div>
                        </div>

                        ${game.network ? `
                        <div class="detail-section">
                            <h3>Broadcast</h3>
                            <div style="font-size: 0.9em; color: var(--text);">${game.network}</div>
                        </div>
                        ` : ''}

                        <div class="detail-section">
                            <h3>Matchup Info</h3>
                            <div class="players-list">
                                <div class="player-item">
                                    <div class="player-name">${awayTeam.shortName || awayTeam.name}</div>
                                    <div class="player-meta">
                                        ${awayTeam.record ? `Record: ${awayTeam.record}` : 'Record: TBD'}
                                    </div>
                                </div>
                                <div class="player-item">
                                    <div class="player-name">${homeTeam.shortName || homeTeam.name}</div>
                                    <div class="player-meta">
                                        ${homeTeam.record ? `Record: ${homeTeam.record}` : 'Record: TBD'} (Home)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Key Stats</h3>
                            <div style="font-size: 0.9em; color: var(--secondary); line-height: 1.8;">
                                <div style="margin-bottom: 8px;">
                                    <strong>Spread:</strong> ${odds.spread > 0 ? '+' : ''}${odds.spread}
                                    (${Math.abs(odds.spread) > 2.5 ? 'Favored Matchup' : 'Close Game'})
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>Total:</strong> ${odds.total} points
                                </div>
                                <div style="font-size: 0.85em; color: var(--secondary); margin-top: 12px;">
                                    For detailed player matchups and injury reports, check team social media
                                    and official league sources.
                                </div>
                            </div>
                        </div>
                    `;
                } else if (isFinal) {
                    // FINAL game content
                    const recap = generateRecap(game);
                    const cachedVideoUrl = getVideoUrl(game.awayTeam, game.homeTeam);
                    const videoUrl = game.video_url || cachedVideoUrl || null;

                    html = `
                        <div class="detail-section">
                            <h3>Final Score</h3>
                            <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--green);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: var(--text);">${awayTeam.shortName || awayTeam.name}</span>
                                    <span style="font-size: 1.3em; font-weight: 800; color: var(--text);">${game.awayScore ?? 0}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: var(--text);">${homeTeam.shortName || homeTeam.name}</span>
                                    <span style="font-size: 1.3em; font-weight: 800; color: var(--text);">${game.homeScore ?? 0}</span>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Game Recap</h3>
                            <p style="font-size: 0.9em; line-height: 1.6; color: var(--text);">${recap}</p>
                        </div>

                        <div class="detail-section">
                            <h3>Game Details</h3>
                            <div style="font-size: 0.9em; color: var(--secondary); display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <div style="color: var(--text); font-weight: 600; margin-bottom: 4px;">Point Differential</div>
                                    <div>${Math.abs(game.homeScore - game.awayScore)} points</div>
                                </div>
                                <div>
                                    <div style="color: var(--text); font-weight: 600; margin-bottom: 4px;">Total Score</div>
                                    <div>${game.homeScore + game.awayScore} points</div>
                                </div>
                                <div>
                                    <div style="color: var(--text); font-weight: 600; margin-bottom: 4px;">Location</div>
                                    <div>${game.venue || 'TBD'}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text); font-weight: 600; margin-bottom: 4px;">Game Type</div>
                                    <div>${game.period ? 'Complete' : 'Postponed'}</div>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Betting Results</h3>
                            <div class="odds-breakdown">
                                <div class="odds-item">
                                    <span class="odds-label">Spread ${Math.abs(odds.spread) > 0 ? '(' + (game.homeScore - game.awayScore > odds.spread ? ' Cover' : ' Miss') + ')' : ''}:</span>
                                    <span class="odds-value">${odds.spread > 0 ? '+' : ''}${odds.spread}</span>
                                </div>
                                <div class="odds-item">
                                    <span class="odds-label">Total ${(game.homeScore + game.awayScore > odds.total ? ' Over' : ' Under')}:</span>
                                    <span class="odds-value">${odds.total}</span>
                                </div>
                            </div>
                        </div>

                        ${videoUrl ? `
                        <div class="detail-section">
                            <h3>Highlights</h3>
                            <div style="aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden;">
                                <iframe style="width: 100%; height: 100%; border: none;" src="${videoUrl}" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
                            </div>
                        </div>
                        ` : `
                        <div class="detail-section">
                            <h3>Highlights</h3>
                            <div style="padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px; text-align: center; color: var(--secondary);">
                                <p style="margin: 0;">Video highlights coming soon</p>
                            </div>
                        </div>
                        `}

                        <div class="detail-section">
                            <h3>Venue</h3>
                            <div style="font-size: 0.9em; color: var(--text);">${game.venue || 'TBD'}</div>
                        </div>

                        ${game.network ? `
                        <div class="detail-section">
                            <h3>Broadcast</h3>
                            <div style="font-size: 0.9em; color: var(--text);">${game.network}</div>
                        </div>
                        ` : ''}
                    `;
                }

                content.innerHTML = html;
                drawer.classList.add('open');
                overlay.classList.add('open');
            } catch (e) {
                console.error('Error opening game drawer:', e);
            }
        }

        // Close game details drawer
        // Touch event handling for mobile drawers
        let touchStartY = 0;
        let touchStartX = 0;
        let isSwiping = false;

        function setupTouchHandlers() {
            const drawer = document.getElementById('game-details-drawer');
            const drawerHeader = document.querySelector('.drawer-header');

            if (!drawer) return;

            // Touch start - record initial position
            drawer.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
                touchStartX = e.touches[0].clientX;
                isSwiping = true;
            }, false);

            // Touch move - detect swipe direction
            drawer.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                const touch = e.touches[0];
                const diffY = touch.clientY - touchStartY;
                const diffX = Math.abs(touch.clientX - touchStartX);

                // Only consider vertical swipes (not horizontal scrolling)
                if (diffX < 50 && diffY > 20) {
                    // Swiping down on mobile drawer
                    if (window.innerWidth <= 768) {
                        drawer.style.transform = `translateY(${Math.max(0, diffY)}px)`;
                    }
                }
            }, false);

            // Touch end - close if swiped far enough
            drawer.addEventListener('touchend', (e) => {
                const touch = e.changedTouches[0];
                const diffY = touch.clientY - touchStartY;

                // Close drawer if swiped down more than 100px on mobile
                if (window.innerWidth <= 768 && diffY > 100) {
                    closeGameDrawer();
                } else {
                    // Reset position
                    drawer.style.transform = 'translateY(0)';
                }

                isSwiping = false;
            }, false);

            // Close on header tap for mobile
            if (drawerHeader) {
                drawerHeader.addEventListener('click', (e) => {
                    if (e.target.classList.contains('drawer-close')) {
                        closeGameDrawer();
                    }
                });
            }
        }

        // Optimize drawer positioning for viewport
        function optimizeDrawerPosition() {
            const drawer = document.getElementById('game-details-drawer');
            if (!drawer || !drawer.classList.contains('open')) return;

            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;

            // Mobile: bottom sheet
            if (viewportWidth <= 768) {
                drawer.style.position = 'fixed';
                drawer.style.width = '100%';
                drawer.style.height = 'auto';
                drawer.style.top = 'auto';
                drawer.style.right = 'auto';
                drawer.style.left = '0';
                drawer.style.bottom = '0';
                drawer.style.borderRadius = '12px 12px 0 0';
                drawer.style.maxHeight = '90vh';
            }
            // Desktop: side drawer
            else {
                drawer.style.position = 'fixed';
                drawer.style.width = viewportWidth > 1024 ? '450px' : '420px';
                drawer.style.height = 'auto';
                drawer.style.top = '50%';
                drawer.style.right = viewportWidth > 1024 ? '30px' : '20px';
                drawer.style.left = 'auto';
                drawer.style.bottom = 'auto';
                drawer.style.transform = 'translateY(-50%)';
                drawer.style.borderRadius = '12px';
                drawer.style.maxHeight = '90vh';
            }
        }

        // Handle viewport changes
        window.addEventListener('resize', optimizeDrawerPosition);

        function closeGameDrawer() {
            const drawer = document.getElementById('game-details-drawer');
            const overlay = document.getElementById('drawer-overlay');
            drawer.classList.remove('open');
            overlay.classList.remove('open');
        }

        // Apply theme from preferences
        function applyTheme(theme) {
            const htmlElement = document.documentElement;
            if (theme === 'light') {
                htmlElement.setAttribute('data-theme', 'light');
            } else {
                htmlElement.removeAttribute('data-theme');
            }
        }

        // Initialize theme from preferences
        function initializeTheme() {
            const prefs = preferences.getAll();
            const theme = prefs.theme || 'dark';
            applyTheme(theme);

            // If there's a dark/light toggle in settings, update it
            const themeToggle = document.querySelector('[data-theme-toggle]');
            if (themeToggle) {
                themeToggle.checked = theme === 'light';
            }
        }

        // Toggle theme
        function toggleTheme() {
            const htmlElement = document.documentElement;
            const currentTheme = htmlElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            applyTheme(newTheme);
            preferences.set('theme', newTheme);
        }

        // Settings modal functions
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('open');
            loadSettingsUI();
        }

        function closeSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('open');
        }

        // Notification Center Functions
        function openNotificationCenter() {
            const center = document.getElementById('notification-center');
            center.classList.add('open');
            notificationManager.updateUI(); // Refresh UI when opening
        }

        function closeNotificationCenter() {
            const center = document.getElementById('notification-center');
            center.classList.remove('open');
        }

        function removeNotification(id) {
            notificationManager.removeNotification(parseFloat(id));
        }

        function clearAllNotifications() {
            if (confirm('Clear all notifications?')) {
                notificationManager.clearAll();
            }
        }

        // Analytics Dashboard Functions
        function openAnalyticsDashboard() {
            const dashboard = document.getElementById('analytics-dashboard');
            dashboard.classList.add('open');
            displayAnalyticsContent();
        }

        function closeAnalyticsDashboard() {
            const dashboard = document.getElementById('analytics-dashboard');
            dashboard.classList.remove('open');
        }

        function displayAnalyticsContent() {
            const content = document.getElementById('analytics-content');
            const accuracy = analyticsManager.getPredictionAccuracy();
            const teamStats = analyticsManager.getAllTeamStats();
            const recentGames = analyticsManager.getRecentGames(5);

            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 1em;">Prediction Accuracy</h3>
                    <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid var(--accent1); padding: 12px; border-radius: 6px;">
                        <div style="font-size: 2em; font-weight: 700; color: var(--accent1);">${accuracy.accuracy}%</div>
                        <div style="font-size: 0.85em; color: var(--secondary); margin-top: 4px;">${accuracy.correct} correct out of ${accuracy.total} predictions</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 1em;">Team Standings</h3>
                    <div style="font-size: 0.85em;">
                        ${teamStats.slice(0, 5).map(stat => `
                            <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span style="color: var(--text); font-weight: 600;">${stat.team}</span>
                                <span style="color: var(--secondary);">${stat.wins}-${stat.losses}${stat.ties ? `-${stat.ties}` : ''}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div>
                    <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 1em;">Recent Games</h3>
                    <div style="font-size: 0.8em;">
                        ${recentGames.length === 0 ? '<div style="color: var(--secondary); text-align: center; padding: 16px;">No games recorded yet</div>' : recentGames.map(game => `
                            <div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <div style="color: var(--text); font-weight: 600; margin-bottom: 4px;">${game.awayTeam} @ ${game.homeTeam}</div>
                                <div style="color: var(--secondary);">${game.awayScore} - ${game.homeScore} <span style="margin-left: 8px; font-size: 0.75em;">${game.date}</span></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            content.innerHTML = html;
        }

        function clearAnalyticsHistory() {
            if (confirm('Clear all analytics history? This cannot be undone.')) {
                analyticsManager.clearHistory();
                displayAnalyticsContent();
                showToast('Analytics history cleared', 'info');
            }
        }

        // Load settings UI from preferences
        function loadSettingsUI() {
            const prefs = preferences.getAll();

            // Load league checkboxes
            const leagues = ['NFL', 'NBA', 'WNBA', 'NHL', 'MLB', 'MLS'];
            const leagueContainer = document.getElementById('league-checkboxes');
            leagueContainer.innerHTML = leagues.map(league => `
                <label class="team-checkbox">
                    <input type="checkbox" data-league="${league}" ${prefs.favoriteLeagues.includes(league) ? 'checked' : ''}>
                    <label>${league}</label>
                </label>
            `).join('');

            // Load team checkboxes
            const teams = ['KC', 'NE', 'DAL', 'GB', 'SF', 'LAR', 'MIN', 'PHI', 'LAC', 'BUF', 'NYG', 'CHI', 'TB', 'NO'];
            const teamContainer = document.getElementById('team-checkboxes');
            teamContainer.innerHTML = teams.map(team => `
                <label class="team-checkbox">
                    <input type="checkbox" data-team="${team}" ${prefs.favoriteTeams.includes(team) ? 'checked' : ''}>
                    <label>${team}</label>
                </label>
            `).join('');

            // Load notification settings
            document.getElementById('notify-enabled').checked = prefs.notificationsEnabled;
            document.getElementById('notify-sound').checked = prefs.notificationSound;
            document.getElementById('timezone-select').value = prefs.timeZone;

            // Load quiet hours
            document.getElementById('quiet-start').innerHTML = Array.from({ length: 24 }, (_, i) => `
                <option value="${i}" ${i === prefs.quietHoursStart ? 'selected' : ''}>${i.toString().padStart(2, '0')}:00</option>
            `).join('');
            document.getElementById('quiet-end').innerHTML = Array.from({ length: 24 }, (_, i) => `
                <option value="${i}" ${i === prefs.quietHoursEnd ? 'selected' : ''}>${i.toString().padStart(2, '0')}:00</option>
            `).join('');

            // Load theme preference
            const themeToggle = document.getElementById('theme-toggle');
            const themeLabel = document.getElementById('theme-label');
            const currentTheme = prefs.theme || 'dark';
            themeToggle.checked = currentTheme === 'light';
            themeLabel.textContent = currentTheme === 'light' ? 'Light' : 'Dark';

            // Add theme toggle change listener
            themeToggle.removeEventListener('change', onThemeToggleChange);
            themeToggle.addEventListener('change', onThemeToggleChange);
        }

        // Theme toggle change handler
        function onThemeToggleChange(e) {
            const newTheme = e.target.checked ? 'light' : 'dark';
            const themeLabel = document.getElementById('theme-label');
            themeLabel.textContent = newTheme === 'light' ? 'Light' : 'Dark';
            applyTheme(newTheme);
        }

        // Save settings to preferences
        function saveSettings() {
            // Save favorite leagues
            const leagueCheckboxes = document.querySelectorAll('#league-checkboxes input[type="checkbox"]');
            const favoriteLeagues = Array.from(leagueCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.league);
            preferences.set('favoriteLeagues', favoriteLeagues);

            // Save favorite teams
            const teamCheckboxes = document.querySelectorAll('#team-checkboxes input[type="checkbox"]');
            const favoriteTeams = Array.from(teamCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.team);
            preferences.set('favoriteTeams', favoriteTeams);

            // Save notification settings
            preferences.set('notificationsEnabled', document.getElementById('notify-enabled').checked);
            preferences.set('notificationSound', document.getElementById('notify-sound').checked);
            preferences.set('quietHoursStart', parseInt(document.getElementById('quiet-start').value));
            preferences.set('quietHoursEnd', parseInt(document.getElementById('quiet-end').value));
            preferences.set('timeZone', document.getElementById('timezone-select').value);

            // Save theme preference
            const themeToggle = document.getElementById('theme-toggle');
            const newTheme = themeToggle.checked ? 'light' : 'dark';
            preferences.set('theme', newTheme);

            // Show success message
            showToast('Preferences saved successfully', 'success');
            closeSettings();
        }

        // Reset settings to defaults
        function resetSettings() {
            if (confirm('Are you sure you want to reset all preferences to defaults?')) {
                preferences.reset();
                loadSettingsUI();
                initializeTheme();
                showToast('Preferences reset to defaults', 'info');
            }
        }

        // Simple toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                background: ${type === 'success' ? '#22c55e' : '#6366f1'};
                color: white;
                z-index: 1000;
                font-size: 0.9em;
                font-weight: 600;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close settings on overlay click
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('settings-modal');
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeSettings();
                }
            });
        });

        // Initialize news ticker
        async function initNewsTicker() {
            try {
                if (window.FranchiseNewsWidget) {
                    await window.FranchiseNewsWidget.initTicker({
                        mountSelector: '#franchise-news-ticker-bottom',
                        categories: [
                            window.NEWS_CATEGORIES.TRADE_PRESS,
                            window.NEWS_CATEGORIES.BIG_PORTALS
                        ],
                        tickerSpeed: 90,
                        pauseOnHover: true,
                        showLabel: true,
                        labelText: 'Franchise News',
                        labelIcon: ''
                    });
                }
            } catch (error) {
                console.error('Failed to initialize news ticker:', error);
            }
        }

        // Generate game recap text
        function generateRecap(game) {
            const homeScore = game.homeScore ?? 0;
            const awayScore = game.awayScore ?? 0;
            const homeTeam = game.homeTeam?.shortName || game.homeTeam?.name || 'Home';
            const awayTeam = game.awayTeam?.shortName || game.awayTeam?.name || 'Away';

            const winner = homeScore > awayScore ? homeTeam : awayTeam;
            const loser = homeScore > awayScore ? awayTeam : homeTeam;
            const winScore = Math.max(homeScore, awayScore);
            const loseScore = Math.min(homeScore, awayScore);
            const diff = winScore - loseScore;

            let templateType = 'normal';
            if (diff >= 14) templateType = 'blowout';
            else if (diff <= 3) templateType = 'close';

            const templates = RECAP_TEMPLATES[templateType];
            const template = templates[Math.floor(Math.random() * templates.length)];

            return template
                .replace('{winner}', winner)
                .replace('{loser}', loser)
                .replace('{winScore}', winScore)
                .replace('{loseScore}', loseScore);
        }

        // Build highlight card HTML
        function buildHighlightCard(game, leagueKey) {
            const homeTeam = game.homeTeam || {};
            const awayTeam = game.awayTeam || {};
            const homeScore = game.homeScore ?? 0;
            const awayScore = game.awayScore ?? 0;
            const defaultLogo = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23334155%22 width=%22100%22 height=%22100%22/></svg>';

            const gameDate = new Date(game.startTime);
            const dateStr = gameDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            const recap = generateRecap(game);

            // Check for video sources (priority: video_url from game data > cached video URL > highlight)
            const cachedVideoUrl = getVideoUrl(awayTeam, homeTeam);
            const youtubeEmbed = game.video_url || cachedVideoUrl || null;  // From game data or cache
            const espnHighlight = game.highlight || null;
            const youtubeUrl = game.youtubeSearch || getYouTubeSearchUrl(
                awayTeam.shortName || awayTeam.name,
                homeTeam.shortName || homeTeam.name,
                leagueKey
            );
            const highlightTitle = game.highlightTitle || 'Game Highlights';
            const hasVideo = youtubeEmbed || espnHighlight;

            // Encode data for onclick
            const gameData = encodeURIComponent(JSON.stringify({
                away: awayTeam.shortName || awayTeam.name,
                home: homeTeam.shortName || homeTeam.name,
                league: leagueKey,
                espnVideo: espnHighlight,
                youtubeUrl: youtubeUrl,
                youtubeEmbed: youtubeEmbed,
                title: highlightTitle
            }));

            return `
                <div class="highlight-card" onclick="openHighlightModal('${gameData}')">
                    <div class="highlight-thumbnail">
                        <div class="team-logos">
                            <img src="${awayTeam.logoUrl || defaultLogo}" alt="${awayTeam.name}" onerror="this.src='${defaultLogo}'">
                            <span class="vs-text">@</span>
                            <img src="${homeTeam.logoUrl || defaultLogo}" alt="${homeTeam.name}" onerror="this.src='${defaultLogo}'">
                        </div>
                        <div class="play-overlay">
                            <div class="play-btn"></div>
                        </div>
                        ${hasVideo ? '<span class="video-badge">VIDEO</span>' : ''}
                    </div>
                    <div class="highlight-info">
                        <div class="highlight-matchup">
                            <span class="highlight-teams">${awayTeam.shortName || awayTeam.name} @ ${homeTeam.shortName || homeTeam.name}</span>
                            <span class="highlight-score">${awayScore} - ${homeScore}</span>
                        </div>
                        <div class="highlight-meta">
                            <span>${dateStr}</span>
                            <span class="highlight-badge">FINAL</span>
                        </div>
                        <p class="highlight-recap">${recap}</p>
                    </div>
                </div>
            `;
        }

        // Render highlights for completed games
        async function renderHighlights() {
            const container = document.getElementById('highlights-grid');

            // Load video URLs from unified data (if available)
            await loadVideoUrls();

            const games = enrichGamesWithVideoUrls(await fetchGames(currentLeague));

            // Filter for completed games only
            const completedGames = games.filter(game => normalizeStatus(game) === 'FINAL');

            if (completedGames.length === 0) {
                container.innerHTML = `
                    <div class="empty-msg" style="grid-column: 1 / -1;">
                        <h3>No ${currentLeague} highlights available</h3>
                        <p>Check back after games are completed for highlights and recaps.</p>
                    </div>
                `;
                return;
            }

            // Sort by most recent first
            completedGames.sort((a, b) => {
                const timeA = new Date(a.startTime || 0).getTime();
                const timeB = new Date(b.startTime || 0).getTime();
                return timeB - timeA;
            });

            container.innerHTML = completedGames.map(game => buildHighlightCard(game, currentLeague)).join('');
        }

        // Generate YouTube search URL for game highlights
        function getYouTubeSearchUrl(awayTeam, homeTeam, league) {
            const searchQuery = `${awayTeam} vs ${homeTeam} ${league} highlights`;
            return `https://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}`;
        }

        // Simple video modal - same approach as test page
        function openVideoModal(url, title) {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('video-iframe');
            const titleEl = document.getElementById('modal-title');

            if (url) {
                // Set the title
                if (titleEl) titleEl.textContent = title + ' Highlights';

                // Set the video URL - this is the key part
                iframe.src = url;

                // Show modal
                modal.classList.add('open');
            }
        }

        // Close video modal
        function closeVideoModal() {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('video-iframe');

            // Stop the video by clearing src
            iframe.src = '';

            // Hide modal
            modal.classList.remove('open');
        }

        // Legacy function for backwards compatibility
        function openHighlightModal(encodedData) {
            let gameData;
            try {
                gameData = JSON.parse(decodeURIComponent(encodedData));
            } catch (e) {
                return;
            }

            const { youtubeEmbed, away, home } = gameData;
            if (youtubeEmbed) {
                openVideoModal(youtubeEmbed, `${away} @ ${home}`);
            }
        }
        // Setup modal event listeners
        function setupModalEvents() {
            // Video modal - Close on background click
            document.getElementById('video-modal').addEventListener('click', (e) => {
                if (e.target.id === 'video-modal') closeVideoModal();
            });

            // Drawer - Close on overlay click
            const overlay = document.getElementById('drawer-overlay');
            if (overlay) {
                overlay.addEventListener('click', closeGameDrawer);
            }

            // Setup touch handlers for mobile drawer
            setupTouchHandlers();

            // Close modals on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeVideoModal();
                    closeGameDrawer();
                }
            });

            // Optimize drawer position on modal open
            const originalOpenGameDrawer = window.openGameDrawer;
            window.openGameDrawer = async function(event, gameData) {
                await originalOpenGameDrawer(event, gameData);
                setTimeout(() => optimizeDrawerPosition(), 100);
            };
        }

        // Initialize app
        // Populate sports headlines ticker
        function updateSportsTicker() {
            const container = document.getElementById('sports-ticker-container');
            if (!container) return;

            // Get all games from cache
            let allGames = [];
            for (const games of Object.values(gamesCache)) {
                allGames = allGames.concat(games);
            }

            // Sort by start time
            allGames.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            // Create ticker items
            const html = allGames.map(game => {
                const homeTeam = game.homeTeam || {};
                const awayTeam = game.awayTeam || {};
                const status = normalizeStatus(game);
                const isFinal = status === 'FINAL';
                const isLive = status === 'LIVE';
                const isUpcoming = status === 'UPCOMING';

                let statusClass = 'ticker-status-upcoming';
                let statusText = 'UPCOMING';

                if (isFinal) {
                    statusClass = 'ticker-status-final';
                    statusText = 'FINAL';
                } else if (isLive) {
                    statusClass = 'ticker-status-live';
                    statusText = 'LIVE';
                }

                const homeScore = game.homeScore ?? 0;
                const awayScore = game.awayScore ?? 0;
                const gameTime = new Date(game.startTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                let scoreHTML = '';
                if (isFinal || isLive) {
                    scoreHTML = `<span class="ticker-item-score">${awayScore}-${homeScore}</span>`;
                } else {
                    scoreHTML = `<span class="ticker-item-score">${gameTime}</span>`;
                }

                return `
                    <div class="ticker-item">
                        <div class="ticker-item-teams">
                            ${awayTeam.shortName || awayTeam.name || 'TBA'}
                            <span style="color: var(--secondary); margin: 0 4px;">@</span>
                            ${homeTeam.shortName || homeTeam.name || 'TBA'}
                        </div>
                        ${scoreHTML}
                        <span class="ticker-item-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Check if there are any live games
        function hasLiveGames() {
            for (const games of Object.values(gamesCache)) {
                if (games.some(game => normalizeStatus(game) === 'LIVE')) {
                    return true;
                }
            }
            return false;
        }

        // Setup adaptive refresh intervals (faster for live games)
        function setupAdaptiveRefresh() {
            let lastRefreshTime = Date.now();
            const fastInterval = 5000;  // 5 seconds for live games
            const slowInterval = 60000; // 60 seconds for completed/upcoming games

            setInterval(async () => {
                const isLive = hasLiveGames();
                const timeSinceLastRefresh = Date.now() - lastRefreshTime;
                const minInterval = isLive ? fastInterval : slowInterval;

                if (timeSinceLastRefresh >= minInterval) {
                    gamesCache = {}; // Clear cache to force fresh fetch
                    videoUrlCache = {}; // Clear video cache
                    await renderGames(); // Re-render will regenerate week selector
                    updateSportsTicker(); // Update ticker with new data
                    lastRefreshTime = Date.now();
                }
            }, 2000); // Check every 2 seconds if we need to refresh
        }

        async function init() {
            // Initialize theme and preferences
            initializeTheme();

            setupLeagueTabs();
            setupTeamFilter();
            setupAdvancedFilters();
            setupModalEvents();

            // Load initial games and generate week selector
            await renderGames();

            // Update sports ticker
            updateSportsTicker();

            // Initialize news ticker
            initNewsTicker();

            // Setup adaptive refresh based on live games
            setupAdaptiveRefresh();
        }

        // Make functions available globally
        window.openVideoModal = openVideoModal;
        window.closeVideoModal = closeVideoModal;
        window.openHighlightModal = openHighlightModal;
        window.openGameDrawer = openGameDrawer;
        window.closeGameDrawer = closeGameDrawer;
        window.loadFilterPreset = loadFilterPreset;
        window.deleteFilterPreset = deleteFilterPreset;
        window.saveFilterPreset = saveFilterPreset;
        window.clearAllFilters = clearAllFilters;
        window.openNotificationCenter = openNotificationCenter;
        window.closeNotificationCenter = closeNotificationCenter;
        window.removeNotification = removeNotification;
        window.clearAllNotifications = clearAllNotifications;
        window.openAnalyticsDashboard = openAnalyticsDashboard;
        window.closeAnalyticsDashboard = closeAnalyticsDashboard;
        window.displayAnalyticsContent = displayAnalyticsContent;
        window.clearAnalyticsHistory = clearAnalyticsHistory;

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
